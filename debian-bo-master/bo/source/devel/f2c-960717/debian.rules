#!/usr/bin/make -f
#   -*- mode: makefile; -*-

# debian.rules file - for f2c, libraries, header file, etc.


package=f2c
version=960717
debian=0
section=devel
pri=optional      
arch=$(shell dpkg --print-architecture)
dir=$(package)-$(version)
file=$(package)_$(version)-$(debian)
flibver=2.1


# Optimization options.
GCCOPT=-ansi -O2 -mieee-fp -fomit-frame-pointer -D_POSIX_SOURCE


build:
	$(checkdir)
	$(MAKE) -C "src" CFLAGS="$(GCCOPT)"
	sh libi77 
	sh libf77
	$(MAKE) -f ./debian.make_lib INTSIZE=f2c
	$(MAKE) -f ./debian.make_lib INTSIZE=f2c_i2
	touch build

clean:
	$(checkdir)
	$(MAKE) -C src clean
	rm -rf libF77 libI77
	rm -f libf2c* *.tmp __*
	cd src && rm -f xsum xsum1.out xsum.out; $(MAKE) -i clean
	rm -f hello hello.o hello.c verify.out hello.P
	rm -f build build_f2c build_f2c_i2
	rm -rf debian-tmp *~

binary: checkroot 
	test -f build || make -i -f debian.rules build	 
	rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	sed -e '1s/=/$(package)/;\
		2s/=/$(version)-$(debian)/;\
		3s/=/$(arch)/;\
		4s/=/$(section)/;'\
		debian.control > debian-tmp/DEBIAN/control	  
	cp debian.postinst debian-tmp/DEBIAN/postinst
	cp debian.postrm debian-tmp/DEBIAN/postrm
	chmod +x debian-tmp/DEBIAN/{postinst,postrm}
	install -d -m 0755             debian-tmp/usr/bin
	install -s -m 0755 src/f2c     debian-tmp/usr/bin/f2c
	install -c -m 0755 fc          debian-tmp/usr/bin/fc
	install -d -m 0755             debian-tmp/usr/man/man1
	install -c -m 0644 src/f2c.1t  debian-tmp/usr/man/man1/f2c.1
	install -d -m 0755             debian-tmp/usr/lib
	install -c -m 0644 libf2c.a    debian-tmp/usr/lib/libf2c.a
	install -c -m 0644 libf2c_i2.a debian-tmp/usr/lib/libf2c_i2.a
	install -d -m 0755             debian-tmp/usr/include
	install -c -m 0644 src/f2c.h   debian-tmp/usr/include/f2c.h
	install -c -m 0644 libf2c.so.$(flibver) \
			            debian-tmp/usr/lib/libf2c.so.$(flibver)
	install -c -m 0644 libf2c_i2.so.$(flibver) \
		                    debian-tmp/usr/lib/libf2c_i2.so.$(flibver)
	install -d -m 0755             debian-tmp/usr/doc/$(package)
	install -c -m 0644 f2c.ps      debian-tmp/usr/doc/$(package)
	install -c -m 0644 changes     debian-tmp/usr/doc/$(package)
	install -c -m 0644 readme      debian-tmp/usr/doc/$(package)
	install -d -m 0755             debian-tmp/usr/doc/copyright
	install -c -m 0644 debian.README \
			            debian-tmp/usr/doc/copyright/$(package)
	(cd debian-tmp/usr/doc/$(package); gzip -9v *)
	chown -R root.root debian-tmp
	chmod -R go-ws debian-tmp
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb 

define checkdir
	test -f ./src/$(package).1t
endef

source:
	-test -f build && make -f debian.rules clean
	(cd .. && tar cvf $(file).tar $(dir) \
	       && gzip -9vf $(file).tar)

diff:
	-test -f build && make -f debian.rules clean
	(cd .. && diff -rPc $(dir).orig $(dir) > $(file).diff; [ $$? = 1 ] \
	       && gzip -9vf $(file).diff)

changes:
	-test -f build && make -f debian.rules clean
	(cd .. && dchanges -n -p -e ce=$(dir)/debian.Changelog p=$(pri)\
		  $(file).tar.gz \
		  $(file).diff.gz \
		  $(file)_$(arch).deb)	      

dist:  binary source diff changes     

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff clean checkroot changes dist

