#   Copyright (C) 1991 Free Software Foundation, Inc.
#
#   This file is part of GNU Pascal Library.
#
#   Makefile to generate the run time system
#
# The GNU Pascal Library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# The GNU Pascal Library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Library General Public License for more details.
#
# You should have received a copy of the GNU Library General Public
# License along with the GNU Pascal Library; see the file COPYING.LIB.  If
# not, write to the Free Software Foundation, Inc., 675 Mass Ave,
# Cambridge, MA 02139, USA.  */

# If you have problems withh RANLIB, check that your standard BSD
# ranlib (which calls "ar" internally) does not get GNU ar, since
# GNU ar does not allow non-object files to be placed into the
# archive!!!!

VPATH = @srcdir@:@rts_gccsrc@

VERSION = 2.8

GPCLIB = libgpc.a

# GPCSOLIB = libgpc.so.$(VERSION)

# We don't install, the upper level make does it for us.

# This needs to be GNU C compiler. Otherwise you'll have trouble
# with the run time system. (e.g. complex_type arguments)
CC = @RTS_GCC@
CFLAGS = @CFLAGS@
AR =  @AR@
AR_FLAGS= rc
RANLIB = @RANLIB@

#
# These might be overriden by the upper level makefile.
#
objdir = ..

# $(srcdir) is the RTS source directory
srcdir = @srcdir@
gccbin = @rts_gccbin@
gccsrc = @rts_gccsrc@

#
# DEBUG		to be able to see run time system debug messages
#		(-Grts -d -- option to your Pascal program. On by default.)
#
#
# You can define these in command line by setting e.g.:
# MY_LIBFLAGS="-DNO_CASECMP" on the top level gpc make command.
#
# JJ 960921: Alert: most of this is obsolete!
#
# The following HAVE_* are defined in rts/rts.h unless you define NO_*
# e.g. HAVE_FTRUNCATE is defined unless you define NO_FTRUNCATE
#
# NO_DEVNULL
#
# In addition, you might define the following (undefined otherwise):
#
# WARN_READ_ONLY
# PATH_SEPARATOR	default '/'
#
# If the included system header files don't specify which kind of system you are,
# the following are currently recognized:
# 
# BSD			BSD system
# _BSD			-"-
#
# USG			SYSTEM V
# SYSV			-"-
#

# Some extra checks for run time system compilation
RTS_WARN=-Wall -Wno-implicit

RTS_CFLAGS = -DGPC $(RTSFLAGS) $(RTS_WARN) $(CFLAGS) # -DDEBUG

INCLUDES= -I$(gccbin) -I$(gccsrc) -I$(gccsrc)/config -I.

ALL_CFLAGS= $(RTS_CFLAGS) $(CPPFLAGS) $(INCLUDES)

PRINT=	print

#
# If you need malloc libary, get it from Emacs or somewere.
#
#MALLOC = malloc.o
MALLOC =

SRCS=	rts-version.c rts-write.c rts-read.c  rts-file.c \
	rts-random.c rts-heap.c  rts-setup.c rts-rt0.c  \
	rts-error.c  rts-times.c rts-misc.c  rts-set.c \
	rts-math.c rts-string.c rts-rdsub.c rts-zmath.c \
	rts-bind.c

# Also as defines to split the math file
MATHOBJS= p_ARCTAN.o p_SQRT.o p_LN.o p_EXP.o p_SIN.o p_COS.o p_POW.o p_EXPON.o
ZMATHOBJS=z_ARCTAN.o z_SQRT.o z_LN.o z_EXP.o z_SIN.o z_COS.o z_POW.o z_EXPON.o \
	  p_POLAR.o p_ARG.o

OBJS=	rts-version.o rts-write.o rts-read.o  rts-file.o \
	rts-random.o rts-heap.o  rts-setup.o rts-rt0.o  \
	rts-error.o  rts-times.o rts-misc.o  rts-set.o \
	rts-string.o rts-bind.o $(MALLOC)

HS=	rts.h rts-fdr.h rts-hdr.h rts-machine.h

all:	$(GPCLIB)

.c.o:
	$(CC) -c $(ALL_CFLAGS) $<

$(GPCLIB): rts-version.c $(OBJS) $(MATHOBJS) $(ZMATHOBJS)
	-rm -f $(GPCLIB)
	$(AR) $(AR_FLAGS) $(GPCLIB) $(OBJS) $(MATHOBJS) $(ZMATHOBJS)
	$(RANLIB) $(GPCLIB)

#$(GPCSOLIB): rts-version.c $(OBJS) $(MATHOBJS) $(ZMATHOBJS)
#	-rm -f $(GPCSOLIB)
#	$(CC) -shared -Wl,-soname,$(GPCSOLIB) $(GPCLIB) $(OBJS) $(MATHOBJS) $(ZMATHOBJS)
#	ln -s $(GPCSOLIB) libgpc.so

# Always remake to update build count.
rts-version.c: Makefile
	echo 'VARLIST="PROG1"'  > gnuvers.conf
	echo 'PROG1='$(VERSION) >> gnuvers.conf
	sh $(srcdir)/gnuvers.sh gnuvers.conf $(srcdir)/rts-version.in
	-rm -f gnuvers.conf
	mv version.c rts-version.c

rts-string.o: rts-string.c rts-rdsub.c
rts-read.o:   rts-read.c rts-rdsub.c

$(MATHOBJS):  math-stamp
$(ZMATHOBJS): zmath-stamp

math-stamp:	rts-math.c rts.h
	for i in $(MATHOBJS); \
	  do $(CC) -c -o $$i $(CFLAGS) -D`basename $$i .o` $(INCLUDES) $(srcdir)/rts-math.c;\
	done
	touch math-stamp

zmath-stamp:	rts-zmath.c rts.h
	for i in $(ZMATHOBJS); \
	  do $(CC) -c -o $$i $(CFLAGS) -D`basename $$i .o` $(INCLUDES) $(srcdir)/rts-zmath.c;\
	done
	touch zmath-stamp

# Not done here
#install: $(libsubdir)/$(GPCLIB)
#
#$(libsubdir)/$(GPCLIB): $(GPCLIB)
#	$(INSTALL_PROGRAM) $(GPCLIB) $(libsubdir)/$(GPCLIB)
#	$(RANLIB) $(libsubdir)/$(GPCLIB)

depend: $(SRCS) $(HS)
	mkdep $(CFLAGS) $(SRCS) $(HS)

clean:
	-rm -f $(GPCLIB) $(OBJS) $(MATHOBJS) $(ZMATHOBJS)
	-rm -f math-stamp zmath-stamp rts-version.o rts-version.c gnuvers.conf
	-rm -f core *~ *.BAK miten.meni* 

lint:
	lint $(CCFLAGS) $(SRCS)

distclean: clean
	-rm -f Makefile rts-config.h rts-version.c version 

print:
	$(PRINT) $(HS) $(SRCS)

# DO NOT DELETE THIS LINE -- mkdep uses it.
# DO NOT PUT ANYTHING AFTER THIS LINE, IT WILL GO AWAY.

# IF YOU PUT ANYTHING HERE IT WILL GO AWAY
