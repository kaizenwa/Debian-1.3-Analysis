#!/usr/bin/make -f
## Time-stamp: <96/07/18 18:52:37 ecl>

## This is the debian.rules file for the package
## ratfor, by Emilio C. Lopes <ecl@finpe.if.usp.br>.

## The name of the package.
p = ratfor77
## The version of the package.
v = 1.0
## The Debian revision of the package.
d = 3
## The architecture
a = $(shell dpkg --print-architecture)
## Priority
u = extra

default: test_dir
	@echo The following targets are defined:
	@echo \ \ build: Builds the binary package $(p).
	@echo \ \ clean: Undoes the effect of target \`build\'.
	@echo \ \ binary: Creates the Debian package $(p).
	@echo \ \ source: Makes the source file for package $(p).
	@echo \ \ diff: Makes the diff file for package $(p).
	@echo \ \ changes: Makes the changes file for package $(p).

test_dir:
	@test "$$(basename $$(pwd))" = "$(p)-$(v)" || \
	  { echo You must execute this script from directory $(p)-$(v).;\
	    false }

build: test_dir
## Builds the binary package.
	make
	touch stamp-build

clean: test_dir
## Undoes the effect of `make -f debian.rules build'.
	make clean
	rm -f stamp-build
	rm -rf debian-tmp

binary: test_dir
## Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	rm -rf debian-tmp >& /dev/null
	install -d -o root -g root -m 755 debian-tmp
	chmod g-s debian-tmp
	install -d -o root -g root -m 755 debian-tmp/usr/bin
	install -s -o root -g root -m 755 ratfor debian-tmp/usr/bin
	install -d -o root -g root -m 755 debian-tmp/usr/man/man1
	install -o root -g root -m 644 ratfor.1 debian-tmp/usr/man/man1
	install -d -o root -g root -m 755 debian-tmp/usr/doc/$(p)
	install -o root -g root -m 644 debian.README README BUGS\
	  debian-tmp/usr/doc/$(p)
	install -d -o root -g root -m 755 debian-tmp/usr/doc/$(p)/examples
	install -o root -g root -m 644 *.r \
	  debian-tmp/usr/doc/$(p)/examples
	gzip -9f debian-tmp/usr/doc/$(p)/examples/*.r
	install -d -o root -g root -m 755 \
	  debian-tmp/usr/doc/copyright
	install -o root -g root -m 644 copyright \
	  debian-tmp/usr/doc/copyright/$(p)
	install -d -o root -g root -m 755 debian-tmp/DEBIAN
	sed -e '1s/=P/$(p)/' -e '2s/=V/$(v)/' -e '2s/=D/$(d)/' \
	  -e '3s/=A/$(a)/' -e '4s/=U/$(u)/' \
	        debian.control > debian-tmp/DEBIAN/control
	chmod 644 debian-tmp/DEBIAN/control
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb

source: test_dir
## Makes a source file.
	cd ..; \
	  tar cvf - $(p)-$(v) | gzip -9 > $(p)_$(v)-$(d).tar.gz

diff: test_dir
## Makes a diff file.
	cd ..; \
	  diff -uNr $(p)-$(v).orig/ $(p)-$(v)/ | \
	     gzip -9c > $(p)_$(v)-$(d).diff.gz

changes: test_dir
## Makes the changes file.
	cd ..; \
	  dchanges ce=$(p)-$(v)/ChangeLog \
	        $(p)_$(v)-$(d)_$(a).deb \
	        $(p)_$(v)-$(d).tar.gz \
	        $(p)_$(v)-$(d).diff.gz

.PHONY: test_dir default build clean binary source diff changes
