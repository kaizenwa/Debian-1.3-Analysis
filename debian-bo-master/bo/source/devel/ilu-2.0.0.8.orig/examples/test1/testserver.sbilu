#!/bin/sh

logfile=/tmp/ilutestlog$$

ILU_BINDING_SERVICE="test$$:127.0.0.1:29939"
export ILU_BINDING_SERVICE
echo "ILU_BINDING_SERVICE is $ILU_BINDING_SERVICE..."

ILU_DEBUG="most" ; export ILU_DEBUG

if test -x ../../etc/sbserver/ilusb ; then
  echo "Starting simple binding service (and waiting a bit for it to start up)..."
  ../../etc/sbserver/ilusb -f ${logfile}-sblog >${logfile}-ilusb 2>&1 &
  sbPID=$!
  sleep 10
else
  echo "No simple binding server executable.  Failed test."
  exit 1
fi

if test -x ./server ; then
  echo "Starting server (and waiting a bit for it to start up)..."
  ./server >${logfile}-server 2>&1 &
  serverPID=$!
  sleep 10
else
  echo "No server executable.  Failed test."
  kill $sbPID ; rm -rf ${logfile}-sblog ${logfile}-ilusb
  exit 1
fi

echo "Running client against server..."
./client >${logfile}-client 2>&1
clientstatus=$?
if test $clientstatus != 0; then
  echo "*** Client program reports errors:  logfiles are ${logfile}-{sblog,ilusb,client,server}"
else
  echo "Client run successful."
  rm -f ${logfile}-server ${logfile}-client
fi
echo "Killing server..."
kill $serverPID
echo "Killing simple binding server..."
kill $sbPID ; sleep 2 ; rm -rf ${logfile}-sblog ${logfile}-ilusb
echo "Exiting with status $clientstatus."
exit $clientstatus
