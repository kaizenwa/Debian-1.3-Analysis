##
## Makefile    For the NYS YP (NIS version 2) server
##
## Copyright (c) 1993,1994 Signum Support AB, Sweden
##	     (c) 1996,1997 Thorsten Kukuk, Germany
##
## This file is part of the NYS YP Server.
##
## The NYS YP Server is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## The NYS YP Server is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
## 
## You should have received a copy of the GNU General Public
## License along with the NYS YP Server; see the file COPYING.  If
## not, write to the Free Software Foundation, Inc., 675 Mass Ave,
## Cambridge, MA 02139, USA.
##
## Author: Peter Eriksson <pen@signum.se>
##
## Changed for configure: Thorsten Kukuk <kukuk@uni-paderborn.de>
##
## $Id: Makefile.in,v 1.16 1997/03/07 15:50:56 kukuk Exp $
##
#### Start of system configuration section. ####

prefix = @prefix@
exec_prefix = @exec_prefix@

## Remember to modify the ypMakefile if you modify YPBINDIR !
YPBINDIR= @libexecdir@/yp
YPMAPDIR= /var/yp
SBINDIR = $(exec_prefix)/sbin
CONFDIR = @sysconfdir@
MAN5DIR = $(prefix)/man/man5
MAN8DIR = $(prefix)/man/man8

## Change this only, if your securenets file is in an 
## unusual place. Normaly, ypserv will search for a file
## "securenets" in YPMAPDIR. You must also add 
## -DSECURENETS='"$(SECURENETS)"' to CPPFLAGS.
#SECURENETS = $(YPMAPDIR)/securenets
SECURENETS = /etc/ypserv.securenets

## How many children of ypserv should be run max. at one time
MAXCHILDREN = 20
XFRBLOCKSIZE= 65535

## Should we install ypmake ("yes" OR "no")
build-ypmake = @YPMAKE@

## Where the ypmake sources are:
YPMAKESRC = @srcdir@/ypmake

srcdir  = @srcdir@
VPATH   = @srcdir@

CC = @CC@
CPP = @CPP@
AWK = @AWK@
CAT = @CAT@
RM  = @RM@

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@ -m 755
INSTALL_DATA = @INSTALL_DATA@

# General compile options and libs:
DEFS = @DEFS@ 
LIBS = @LIBS@ 
LIBDBM = @LIBDBM@
RESOLV = @RESOLV@
TCP_WRAP = @TCP_WRAP@
LIBRPC = @LIBRPC@

CFLAGS = @CFLAGS@ 
CPPFLAGS = @CPPFLAGS@ -DYPMAPDIR='"$(YPMAPDIR)"' -DYPBINDIR='"$(YPBINDIR)"'\
		-DCONFDIR='"$(CONFDIR)"' -DMAX_CHILDREN=$(MAXCHILDREN)\
		-DXFRBLOCKSIZE=$(XFRBLOCKSIZE) -DSECURENETS='"$(SECURENETS)"'

LDFLAGS = @LDFLAGS@
WARNFLAGS = @WARNFLAGS@

#### End of system configuration section. ####

SHELL = /bin/sh

PGMS=		ypserv yppush makedbm ypxfr revnetgroup ypinit mknetid\
		ypMakefile ypxfr_1perhour ypxfr_2perday ypxfr_1perday\
		rpc.ypxfrd
SRCS=		server.c ypserv.c ypserv_xdr.c yppush.c yppush_xdr.c\
		ypxfr.c ypxfr_xdr.c ypxfr_clnt.c makedbm.c hash.c\
		dns_hosts.c access.c yp_msg.c revnetgroup.c getnetgrent.c\
		ypserv_conf.c mknetid.c netid_hash.c ypxfrd_svc.c\
		ypxfrd_server.c ypxfrd.c ypxfrd_getmap.c yp_db.c ypxfrd_xdr.c
YPSERVOBJ=	server.o ypserv.o ypserv_xdr.o dns_hosts.o access.o yp_msg.o\
		ypserv_conf.o yp_db.o
YPPUSHOBJ=	yppush.o yppush_xdr.o yp_msg.o
YPXFRDOBJ=	ypxfrd_svc.o ypxfrd_server.o access.o ypxfrd.o ypxfrd_xdr.o \
		ypserv_conf.o yp_msg.o dns_hosts.o yp_db.o
YPXFROBJ=	ypxfr.o ypxfr_clnt.o ypxfr_xdr.o yp_msg.o ypxfrd_getmap.o \
		ypxfrd_xdr.o
MAKEDBMOBJ=	makedbm.o
REVNETGROUPOBJ=	revnetgroup.o getnetgrent.o hash.o
MKNETIDOBJ=	mknetid.o netid_hash.o
MANPAGES=	ypserv.8 ypserv.conf.5 yppush.8 ypxfr.8 ypinit.8 netgroup.5\
		revnetgroup.8 rpc.ypxfrd.8 ypxfrd.8 mknetid.8

COMPILE = $(CC) -c $(CPPFLAGS) $(DEFS) -I. -I$(srcdir) $(CFLAGS) $(WARNFLAGS)

.c.o:
	$(COMPILE) $<

all:	.depend sedscript $(PGMS) $(MANPAGES)

ypserv: $(YPSERVOBJ)
	$(CC) -o ypserv $(YPSERVOBJ) $(LDFLAGS) $(LIBS) $(RESOLV) $(TCP_WRAP) $(LIBDBM)

yppush: $(YPPUSHOBJ)
	$(CC) -o yppush $(YPPUSHOBJ) $(LDFLAGS) $(LIBS) $(LIBDBM)

ypxfr:	$(YPXFROBJ)
	$(CC) -o ypxfr $(YPXFROBJ) $(LDFLAGS) $(LIBS) $(LIBDBM) $(LIBRPC)

makedbm: $(MAKEDBMOBJ)
	$(CC) $(CFLAGS) -o makedbm $(MAKEDBMOBJ) $(LIBS) $(LIBDBM)

revnetgroup: $(REVNETGROUPOBJ)
	$(CC) $(CFLAGS) -o revnetgroup $(REVNETGROUPOBJ) $(LIBS)

mknetid: $(MKNETIDOBJ)
	$(CC) $(CFLAGS) -o mknetid $(MKNETIDOBJ) $(LIBS)

rpc.ypxfrd: $(YPXFRDOBJ)
	$(CC) $(CFLAGS) -o rpc.ypxfrd $(YPXFRDOBJ) $(LIBS) $(RESOLV) $(TCP_WRAP) $(LIBDBM)

ypinit: $(srcdir)/ypinit.in sedscript
	rm -f ypinit
	./sedscript < $(srcdir)/ypinit.in > ypinit
	chmod 755 ypinit

ypxfr_1perhour: $(srcdir)/ypxfr_1perhour.in sedscript
	rm -f ypxfr_1perhour
	./sedscript < $(srcdir)/ypxfr_1perhour.in > ypxfr_1perhour
	chmod 755 ypxfr_1perhour

ypxfr_2perday: $(srcdir)/ypxfr_2perday.in sedscript
	rm -f ypxfr_2perday
	./sedscript < $(srcdir)/ypxfr_2perday.in > ypxfr_2perday
	chmod 755 ypxfr_2perday

ypxfr_1perday: $(srcdir)/ypxfr_1perday.in sedscript
	rm -f ypxfr_1perday
	./sedscript < $(srcdir)/ypxfr_1perday.in > ypxfr_1perday
	chmod 755 ypxfr_1perday

ypMakefile: $(srcdir)/ypMakefile.in sedscript
	rm -f ypMakefile
	./sedscript < $(srcdir)/ypMakefile.in > ypMakefile

ypserv.8: $(srcdir)/ypserv.8.in sedscript
	rm -f ypserv.8
	./sedscript < $(srcdir)/ypserv.8.in > ypserv.8

ypserv.conf.5: $(srcdir)/ypserv.conf.5.in sedscript
	rm -f ypserv.conf.5
	./sedscript < $(srcdir)/ypserv.conf.5.in > ypserv.conf.5

rpc.ypxfrd.8: $(srcdir)/rpc.ypxfrd.8.in sedscript
	rm -f rpc.ypxfrd.8
	./sedscript < $(srcdir)/rpc.ypxfrd.8.in > rpc.ypxfrd.8

yppush.8: $(srcdir)/yppush.8.in sedscript
	rm -f yppush.8
	./sedscript < $(srcdir)/yppush.8.in > yppush.8

ypxfr.8: $(srcdir)/ypxfr.8.in sedscript
	rm -f ypxfr.8
	./sedscript < $(srcdir)/ypxfr.8.in > ypxfr.8

ypinit.8: $(srcdir)/ypinit.8.in sedscript
	rm -f ypinit.8
	./sedscript < $(srcdir)/ypinit.8.in > ypinit.8

mknetid.8: $(srcdir)/mknetid.8.in sedscript
	rm -f mknetid.8
	./sedscript < $(srcdir)/mknetid.8.in > mknetid.8

revnetgroup.8: $(srcdir)/revnetgroup.8.in sedscript
	rm -f revnetgroup.8
	./sedscript < $(srcdir)/revnetgroup.8.in > revnetgroup.8

sedscript: Makefile
	@rm -f sedscript
	@echo "sed \\" > sedscript
	@echo "	-e 's;@YPBINDIR@;$(YPBINDIR);g'\\" >> sedscript
	@echo "	-e 's;@YPMAPDIR@;$(YPMAPDIR);g'\\" >> sedscript
	@echo "	-e 's;@SBINDIR@;$(SBINDIR);g'\\" >> sedscript
	@echo " -e 's;@CONFDIR@;$(CONFDIR);g'\\" >> sedscript
	@echo "	-e 's;@CATPRG@;$(CAT);g'\\" >> sedscript
	@echo "	-e 's;@RMPRG@;$(RM);g'\\" >> sedscript
	@echo "	-e 's;@AWKPRG@;$(AWK);g'" >> sedscript
	@chmod 700 sedscript

clean:
	rm -f $(PGMS) sedscript core *.o *~ ypserv.conf.5 .depend mknetid.8
	rm -f revnetgroup.8 ypinit.8 yppush.8 ypserv.8 ypxfr.8 rpc.ypxfrd.8
	(cd $(YPMAKESRC); make -f Makefile.in clean)

distclean: clean
	rm -f .depend config.log config.status config.h Makefile # config.cache
	(cd $(YPMAKESRC); rm -f Makefile; rm -f defs.sed)

installdirs:
	$(srcdir)/mkinstalldirs $(ROOT)$(YPBINDIR) $(ROOT)$(YPMAPDIR) 
	$(srcdir)/mkinstalldirs $(ROOT)$(SBINDIR) $(ROOT)$(MAN5DIR) 
	$(srcdir)/mkinstalldirs $(ROOT)$(MAN8DIR) $(ROOT)$(CONFDIR)
	$(srcdir)/mkinstalldirs $(ROOT)/usr/include/rpcsvc

install: all installdirs install_progs install_ypmake

install_progs:
	$(INSTALL_PROGRAM) -s ypserv $(ROOT)$(SBINDIR)
	$(INSTALL_DATA) ypserv.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_DATA) ypserv.conf.5 $(ROOT)$(MAN5DIR)
	$(INSTALL_PROGRAM) -s rpc.ypxfrd $(ROOT)$(SBINDIR)
	$(INSTALL_DATA) rpc.ypxfrd.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_DATA) $(srcdir)/ypxfrd.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_PROGRAM) -s yppush $(ROOT)$(SBINDIR)
	$(INSTALL_DATA) yppush.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_PROGRAM) -s ypxfr $(ROOT)$(YPBINDIR)
	$(INSTALL_PROGRAM) ypxfr_1perhour $(ROOT)$(YPBINDIR)
	$(INSTALL_PROGRAM) ypxfr_2perday $(ROOT)$(YPBINDIR)
	$(INSTALL_PROGRAM) ypxfr_1perday $(ROOT)$(YPBINDIR)
	$(INSTALL_DATA) ypxfr.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_PROGRAM) -s makedbm $(ROOT)$(YPBINDIR)
	$(INSTALL_PROGRAM) ypinit $(ROOT)$(YPBINDIR)
	$(INSTALL_DATA) ypinit.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_PROGRAM) -s revnetgroup $(ROOT)$(YPBINDIR)
	$(INSTALL_DATA) revnetgroup.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_PROGRAM) -s mknetid $(ROOT)$(YPBINDIR)
	$(INSTALL_DATA) mknetid.8 $(ROOT)$(MAN8DIR)
	$(INSTALL_DATA) $(srcdir)/netgroup.5 $(ROOT)$(MAN5DIR)	
	if [ -f $(ROOT)$(YPMAPDIR)/Makefile ]; then \
	   $(INSTALL_DATA) ypMakefile $(ROOT)$(YPMAPDIR)/Makefile.new; \
	else \
	   $(INSTALL_DATA) ypMakefile $(ROOT)$(YPMAPDIR)/Makefile; \
	fi
	$(INSTALL_DATA) $(srcdir)/ypxfrd.x $(ROOT)/usr/include/rpcsvc

install_ypmake:
ifneq ($(build-ypmake),no)
	(cd $(YPMAKESRC) && ./configure && make && make install)
endif

ifeq (.depend,$(wildcard .depend))
include .depend
endif

depend dep .depend: $(SRCS)
	$(CPP) $(CPPFLAGS) $(DEFS) -I. -I$(srcdir) -M $(addprefix $(srcdir)/, $(SRCS)) > .depend
