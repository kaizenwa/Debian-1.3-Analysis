#!/usr/bin/make -f
# Sample debian.rules file - for GNU Hello (1.3).
# Copyright 1994,1995 by Ian Jackson.
# I hereby give you perpetual unlimited permission to copy,
# modify and relicense this file, provided that you do not remove
# my name from the file itself.  (I assert my moral right of
# paternity under the Copyright, Designs and Patents Act 1988.)

package=net-acct
version=0.4
debian=1
arch=$(shell dpkg --print-architecture)

# The next section may have to be extensively modified

build:
	$(checkdir)
	(cd src/ ; $(MAKE) CFLAGS=-O2)
	touch build

clean:
	$(checkdir)
	-rm -f build
	-(cd src/ ; $(MAKE) -i distclean)
	-rm -rf debian-tmp *~ DEADJOE *.orig

binary:		checkroot build
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	install -d debian-tmp/usr/doc/net-acct
	install -d debian-tmp/usr/doc/examples/net-acct
	install -d debian-tmp/etc
	install -d debian-tmp/etc/init.d
	install -d debian-tmp/etc/cron.daily
#	install -d debian-tmp/usr/man/man5
#	install -d debian-tmp/usr/man/man8
	sed -e '2s/=/$(version)-$(debian)/; \
		3s/=/$(arch)/;' \
	    debian.control > debian-tmp/DEBIAN/control
	cp debian.postinst debian-tmp/DEBIAN/postinst
	cp debian.preinst debian-tmp/DEBIAN/preinst
	cp debian.postrm debian-tmp/DEBIAN/postrm
	cp debian.conffiles debian-tmp/DEBIAN/conffiles
	chmod +x debian-tmp/DEBIAN/{postinst,preinst,postrm}
	(cd src/ ; $(MAKE) CFLAGS=-O2 prefix=../debian-tmp/usr install)
	strip debian-tmp/usr/sbin/nacctd
	cp debian.README debian-tmp/usr/doc/copyright/$(package)
	cp README* debian-tmp/usr/doc/net-acct/	
	cp CHANGES debian-tmp/usr/doc/net-acct/
	cp debian.Changelog debian-tmp/usr/doc/net-acct/
	cp src/ChangeLog debian-tmp/usr/doc/net-acct/
	cp tools/* debian-tmp/usr/doc/examples/net-acct/
	cp src/naccttab.sample debian-tmp/etc/naccttab
	cp debian.nacctd-init debian-tmp/etc/init.d/net-acct
	cp debian.nacctd-daily debian-tmp/etc/cron.daily/net-acct
	chmod 755 debian-tmp/etc/init.d/net-acct debian-tmp/etc/cron.daily/net-acct
	(cd debian-tmp/usr/doc/net-acct ; gzip -9 *)
	(cd debian-tmp/usr/doc/examples/net-acct ; gzip -9 *)
	chown -R root.root debian-tmp
	chmod -R g-ws,o-w debian-tmp
#	ln -s ../man7/undocumented.7 debian-tmp/usr/man/man8/nacctd.8
#	ln -s ../man7/undocumented.7 debian-tmp/usr/man/man5/naccttab.5
	dpkg --build debian-tmp
	mv debian-tmp.deb ../$(package)-$(version)-$(debian).$(arch).deb

define checkdir
	test -f src/netacct.h
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)-$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)-$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)-$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)-$(version)-$(debian).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff clean checkroot
