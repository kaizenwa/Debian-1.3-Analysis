#! /usr/bin/make -f
#
# To make the distributed dpkg archive, the ``Debianized'' source package
# and the context diff to the original package, type `./debian.rules dist'.
# Make sure that `debian.rules' is executable before the final distribution
# is made.
#
# Invoke each target with `./debian.rules <target>'.  All targets should be
# invoked with the package root as the current directory.

p = scotty
v = 2.0.2
d = 4
a = $(shell dpkg --print-architecture)

build:
# Builds the binary package.
	./configure --prefix=/usr
	make CC=gcc CFLAGS="-O2 -g" LDFLAGS= TCL_LIB=-ltcl7.4 TK_LIB=-ltk4.0
	touch stamp-build

clean:
# Undoes the effect of `make -f debian.rules build'.
	make distclean
	rm -f stamp-build
	rm -rf debian-tmp

binary:
# Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	rm -rf debian-tmp
	install -d debian-tmp
	#
	install -d debian-tmp/usr
	SCOTTY_LIBRARY=`pwd`/debian-tmp/usr/lib/scotty make \
	  prefix=`pwd`/debian-tmp/usr INCLUDE_DIR=debian-tmp/usr/include/tcl \
	  install
	make -C tkined prefix=`pwd`/debian-tmp/usr BIN_DIR=/usr/bin install
	make prefix=`pwd`/debian-tmp/usr sinstall
	strip debian-tmp/usr/bin/*
	strip --strip-debug debian-tmp/usr/lib/libscotty.a
	chmod u+w debian-tmp/usr/bin/*
	rm -rf debian-tmp/usr/man/mann
	rm -rf debian-tmp/usr/lib/scotty/site
	ln -s /usr/local/lib/scotty/site debian-tmp/usr/lib/scotty/site
	install -d debian-tmp/var/lib/scotty
	mv debian-tmp/usr/lib/scotty/unknown-os debian-tmp/var/lib/scotty
	ln -s /var/lib/scotty/unknown-os debian-tmp/usr/lib/scotty/unknown-os
	#
	install -d debian-tmp/usr/doc/copyright
	install -m 644 COPYRIGHT debian-tmp/usr/doc/copyright/$(p)
	install -d debian-tmp/usr/doc/$(p)
	install -m 644 README debian-tmp/usr/doc/$(p)
	gzip -9f debian-tmp/usr/doc/$(p)/*
	install -d debian-tmp/usr/doc/examples/$(p)
	cp -a examples/* debian-tmp/usr/doc/examples/$(p)
	#
	install -d debian-tmp/DEBIAN
	sed -e 's/PpP/$(p)/' -e 's/VvV/$(v)/' -e 's/DdD/$(d)/' \
	  -e 's/AaA/$(a)/' debian.control > debian-tmp/DEBIAN/control
	chmod -R g-sw debian-tmp
	chown -R root.root debian-tmp
	dpkg --build debian-tmp
	dpkg-name -o -s .. debian-tmp.deb

source:
# Makes a source package.
	-test -f stamp-build && make -f debian.rules clean
	( cd .. && \
	  tar cf $(p)_$(v)-$(d).tar $(p)-$(v) && \
	  gzip -9f $(p)_$(v)-$(d).tar )

diff:
# Makes a context diff.
	-test -f stamp-build && make -f debian.rules clean
	test -d ../$(p)-$(v).orig || \
	  ( echo "Original not available in ../$(p)-$(v).orig." ; false )
	( cd .. && \
	  ( diff -uNr $(p)-$(v).orig $(p)-$(v) > $(p)_$(v)-$(d).diff; \
	    [ $$? = 1 ] ) && \
	  gzip -9f $(p)_$(v)-$(d).diff )

FILES = $(p)_$(v)-$(d)_$(a).deb $(p)_$(v)-$(d).{tar.gz,diff.gz}

changes:
# Prepares the checksums and changes files.
	cd .. && dchanges -n -e -p ce=$(p)-$(v)/debian.changes $(FILES)

dist: binary source diff changes
# Prepares the package for distribution.

