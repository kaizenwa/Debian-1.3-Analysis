#!/usr/bin/make -f
# debian.rules file for ipx-1.0
# modifications for ipx-1.0 copyright 1996 Michael Nonweiler.
# modified version of sample debian.rules file written
# and copyright 1994,1995 by Ian Jackson.

package=ipx
version=1.0
debian=1

docfiles=README Samples/*

debtmp=$(shell pwd)/debian-tmp
shipdir=..
architecture=$(shell dpkg --print-architecture)

build:
	$(checkdir)
	$(MAKE)
	touch build

clean:
	$(checkdir)
	-rm -f build *~
	-$(MAKE) -i clean
	-rm -rf $(debtmp)

binary:		checkroot build
	-rm -rf $(debtmp)
	mkdir $(debtmp) $(debtmp)/DEBIAN
	install -d $(debtmp)/usr/doc/copyright
	install -d $(debtmp)/usr/doc/$(package)
	install -d $(debtmp)/usr/bin
	install -d $(debtmp)/usr/sbin
	install -d $(debtmp)/usr/man/man8
	install -d $(debtmp)/etc/init.d

	sed -e '2s/=V/$(version)-$(debian)/; \
		3s/=A/$(architecture)/;' \
	    debian.control > $(debtmp)/DEBIAN/control

	install -m 755 debian.postinst $(debtmp)/DEBIAN/postinst
	install -m 755 debian.prerm $(debtmp)/DEBIAN/prerm
	install -m 755 debian.postrm $(debtmp)/DEBIAN/postrm
	install -m 644 debian.conffiles $(debtmp)/DEBIAN/conffiles

	$(MAKE) prefix=$(debtmp) install

	install -m 644 debian.README $(debtmp)/usr/doc/copyright/$(package)
	install -m 644 $(docfiles) $(debtmp)/usr/doc/$(package)
	gzip -9vf $(debtmp)/usr/doc/$(package)/*

	chown -R root.root $(debtmp)
	chmod -R g-ws $(debtmp)
	dpkg --build $(debtmp)
	mv $(debtmp).deb $(shipdir)/$(package)-$(version)-$(debian).deb

define checkdir
	test -f ipx_configure.c
endef

source:		clean
	chmod +x debian.rules
	cd $(shipdir) && \
	tar cf $(package)-$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)-$(version)-$(debian).tar
 
diff:		clean
	cd $(shipdir) && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)-$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)-$(version)-$(debian).diff

dist: source diff binary

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff dist clean checkroot
