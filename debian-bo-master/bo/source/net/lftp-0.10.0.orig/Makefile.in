VERSION=@VERSION@

DEBUGFLAGS=-g

CC=@CC@
CFLAGS=-O $(DEBUGFLAGS)
CXX=@CXX@
CXXLD=@CXXLD@
RANLIB=@RANLIB@
CXXFLAGS=-O $(DEBUGFLAGS)
LDFLAGS=$(DEBUGFLAGS)

LOADLIBES=@LIBS@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@

READLINE=readline/libreadline.a

INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
INSTALL_PROGRAM=@INSTALL_PROGRAM@

DISTFILES=ftpget.cc ftpclass.cc ftpclass.h parallelftp.cc parallelftp.h\
 lftp.cc xalloca.h getopt.c getopt1.c getopt.h parsecmd.cc\
 alias.cc alias.h SMTask.cc SMTask.h SysCmdJob.cc SysCmdJob.h\
 PollVec.cc PollVec.h ProcWait.cc ProcWait.h Job.h Job.cc XferJob.h\
 XferJob.cc Filter.h Filter.cc ArgV.h ArgV.cc CmdExec.h CmdExec.cc\
 StatusLine.h StatusLine.cc mgetJob.cc mgetJob.h SignalHook.h SignalHook.cc\
 mkrmJob.cc mkrmJob.h commands.cc SiteJob.h SiteJob.cc\
 vars.cc vars.h GetPass.cc GetPass.h CharReader.h CharReader.cc\
 mvJob.cc mvJob.h\
 Makefile.in configure.in configure acconfig.h config.h.in aclocal.m4\
 poll/poll.h poll/poll.c alloca.c COPYING README\
 CHANGES rglob.cc rglob.h lftp.h complete.cc mirror.cc mirror.h\
 MirrorJob.cc MirrorJob.h mputJob.cc mputJob.h xmalloc.h\
 url.cc url.h netrc.cc netrc.h long-options.h long-options.c\
 install-sh TODO $(shell cat readline/DISTFILES)

.o:
	rm -f $@
	$(CXXLD) $(LDFLAGS) -o $@ $^ $(LOADLIBES)

.cc.o:
	$(CXX) -c $(CXXFLAGS) @CFLAGS@ @DEFS@ -I. $<
.c.o:
	$(CC) -c $(CFLAGS) @CFLAGS@ @DEFS@ -I. $<

all: libsmtasks.a libjobs.a ftpget parallelftp lftp

libsmtasks.a: PollVec.o SMTask.o ProcWait.o ftpclass.o rglob.o GetPass.o\
 CharReader.o
	ar r $@ $?
	$(RANLIB) $@

libjobs.a: Job.o XferJob.o ArgV.o Filter.o CmdExec.o commands.o\
 StatusLine.o mgetJob.o SysCmdJob.o mkrmJob.o SiteJob.o	parsecmd.o\
 mirror.o MirrorJob.o mputJob.o vars.o mvJob.o
	ar r $@ $?
	$(RANLIB) $@

ftpget: ftpget.o libjobs.a libsmtasks.a getopt.o getopt1.o\
 long-options.o @READLINE_DEPEND@ @LIBOBJS@ @ALLOCA@

parallelftp: parallelftp.o libsmtasks.a @READLINE_DEPEND@ @LIBOBJS@ @ALLOCA@

lftp: lftp.o libjobs.a libsmtasks.a alias.o getopt.o SignalHook.o\
 complete.o url.o netrc.o @READLINE_DEPEND@ @LIBOBJS@ @ALLOCA@
	rm -f $@
	$(CXXLD) $(LDFLAGS) -o $@ $^ @READLINE_SUPPLIB@ $(LOADLIBES)

poll.o: poll/poll.c
	$(CC) -c $(CFLAGS) @CFLAGS@ @DEFS@ poll/poll.c

$(READLINE):
	$(MAKE) -C readline CC="$(CC)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)"\
	    RANLIB="$(RANLIB)" DEFS="@DEFS@" libreadline.a

install: all
	$(INSTALL_PROGRAM) lftp $(bindir)/lftp
	$(INSTALL_PROGRAM) ftpget $(bindir)/ftpget

clean: clean_local
	-$(MAKE) -C readline clean

clean_local:
	rm -f *.o *.a ftpget parallelftp lftp core

distclean: clean_local
	-$(MAKE) -C readline distclean
	rm -f config.h config.log config.status config.cache Makefile .depend

distdir=lftp-$(VERSION)
dist:
	-mkdir $(distdir) $(distdir)/poll $(distdir)/readline\
 $(distdir)/readline/doc $(distdir)/readline/examples
	for i in $(DISTFILES); do ln -f $$i $(distdir)/$$i; done
	tar czf $(distdir).tar.gz $(distdir)
	rm -rf $(distdir)

.depend:
	-gcc -I. -M @CFLAGS@ *.cc >$@

include .depend
