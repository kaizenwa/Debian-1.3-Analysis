#!/usr/bin/make -f
# debian.rules file for ncpfs
# modifications for ncpfs copyright 1996 Michael Nonweiler.
# modified version of sample debian.rules file written
# and copyright 1994,1995 by Ian Jackson.

package=ncpfs
version=0.23
debian=1

# Note : This package will _not_ build with the includes from
# libc5-dev-5.2.18-6, because of the lack of /usr/include/linux/autoconf.h.
# Symlink the linux and asm include directories to those in the kernel source
# directory to compile.

docfiles=README FAQ BUGS TODO Changes

topdir=$(shell pwd)
architecture=$(shell dpkg --print-architecture)

build:
	$(checkdir)
	$(MAKE)
	touch build

clean:
	$(checkdir)
	-rm -f build
	-$(MAKE) -i mrproper
	-rm -rf debian-tmp

binary:		checkroot build
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	install -d debian-tmp/usr/doc/$(package)
	install -d debian-tmp/usr/bin
	install -d debian-tmp/usr/sbin
	install -d debian-tmp/usr/man/man1
	install -d debian-tmp/usr/man/man5
	install -d debian-tmp/usr/man/man8

	sed -e '2s/=V/$(version)-$(debian)/; \
		3s/=A/$(architecture)/;' \
	    debian.control > debian-tmp/DEBIAN/control

	install -m 755 debian.postinst debian-tmp/DEBIAN/postinst

	$(MAKE) prefix=$(topdir)/debian-tmp install

	install -m 644 debian.README debian-tmp/usr/doc/copyright/$(package)
	install -m 644 $(docfiles) debian-tmp/usr/doc/$(package)
	gzip -9vf debian-tmp/usr/doc/$(package)/*

	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp
	mv debian-tmp.deb ../$(package)-$(version)-$(debian).$(architecture).deb

define checkdir
	test -f util/ncpmount.c
endef

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)-$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)-$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)-$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)-$(version)-$(debian).diff

dist: source diff binary

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff dist clean checkroot
