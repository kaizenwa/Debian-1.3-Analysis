#!/bin/sh
#
# For some reason the guys at BSDI decided to change Makefile syntax.
# Thanks, guys.
#
# mjr@tis.com
#

MASTER=`pwd`/Makefile.config

if [ $# -eq 1 -a "$1" = "unfix" ]; then
	echo "Restoring Makefiles..."
	find . -name Makefile.proto -print | (
		while read name; do
			b=`echo $name | sed 's/.proto//'`
			if [ -f $b ]; then
				echo renaming $b to $b.bak
				mv $b $b.bak
				echo renaming $name to $b
				mv $name $b
			fi
		done
	)
else
	echo "Fixing up Makefiles..."
	echo "(to unfix, type 'fixmake unfix')"
	find . -name Makefile -print | (
		while read name; do
			if [ ! -f $name.proto ]; then
				echo renaming $name to $name.proto
				mv $name $name.proto
			fi
			cat $MASTER > $name
			sed '/^include/d' $name.proto >> $name
			echo "built $name"
		done
	)
fi
