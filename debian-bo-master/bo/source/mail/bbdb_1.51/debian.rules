#!/usr/bin/make -f
# Sample debian.rules file - for GNU Hello (1.3).
# Copyright 1994,1995 by Ian Jackson.
# I hereby give you perpetual unlimited permission to copy,
# modify and relicense this file, provided that you do not remove
# my name from the file itself.  (I assert my moral right of
# paternity under the Copyright, Designs and Patents Act 1988.)
#
# Modified for bbdb by Joe Reinhardt
#

package=bbdb
version=1.51
debian=2
arch=all

# The next section may have to be extensively modified

build:
	$(checkdir)

	-rm -f emacs-version
	-rm -f vm-version

	./package-version emacs > emacs-version
	./package-version vm > vm-version

	if [ -s vm-version ]; \
	then $(MAKE) -f bbdb-Makefile EMACSVERSION=`cat emacs-version` all ; \
	else $(MAKE) -f bbdb-Makefile EMACSVERSION=`cat emacs-version` VM="" all ; \
	fi

	touch build

clean:
	$(checkdir)
	-rm -f build emacs-version vm-version
	-$(MAKE) -i -f bbdb-Makefile clean
	-rm -rf debian-tmp *~

binary:		checkroot build
	-rm -rf debian-tmp
	
	install -d debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	install -d debian-tmp/usr/doc/$(package)
	
	sed -e '2s/=/$(version)-$(debian)/' \
	    debian.control > debian-tmp/DEBIAN/control
	
	cp debian.postinst debian-tmp/DEBIAN/postinst
	cp debian.prerm debian-tmp/DEBIAN/prerm
	chmod +x debian-tmp/DEBIAN/{postinst,prerm}

	install -d debian-tmp/usr/lib/emacs/site-lisp/bbdb
	cp *.elc debian-tmp/usr/lib/emacs/site-lisp/bbdb
	cp bbdb-init.el debian-tmp/usr/lib/emacs/site-lisp

	install -d debian-tmp/usr/lib/bbdb
	cp multicol.tex bbdb-print.tex debian-tmp/usr/lib/bbdb

	install -d debian-tmp/usr/info
	cp bbdb.info debian-tmp/usr/info
	gzip -9v debian-tmp/usr/info/*

	cp debian.DOC debian-tmp/usr/doc/copyright/$(package)
	cp debian.DOC debian-tmp/usr/doc/$(package)/README

	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp

	dpkg --build debian-tmp
	mv debian-tmp.deb ../$(package)_$(version)-$(debian)_$(arch).deb

define checkdir
	test -f bbdb.el
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)_$(version)-$(debian).tar $(package)_$(version) && \
	gzip -9vf $(package)_$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)_$(version).orig $(package)_$(version) \
	 >$(package)_$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)_$(version)-$(debian).diff

checkroot:
	$(checkdir)
	# test root = "`whoami`"

.PHONY: binary source diff clean checkroot
