#!/usr/bin/make -f
#
# Debian rules for building a Debian package
# Version 1.1
#
# These rules have been specifically designed NOT to require root to
# run them. At any time root privileges are required, the command to be
# executed will be made obvious and root's password will be prompted for.
# Of course, root may still run this and no password will be required.
#
# Robert Leslie <rob@mars.org>

PKG =	deliver
VER =	2.1.12
DEB =	2
BLD =	.debian-build
TMP =	.debian-tmp

build :: $(BLD)

binary :: $(BLD)
	su -c 'exec ./debian.binary $(PKG) $(VER)-$(DEB) $(TMP)'
	dpkg --build $(TMP)
	mv -f $(TMP).deb ../$(PKG)-$(VER)-$(DEB).deb

$(BLD):
	test -f conf/local.h.orig || {  \
	  mv conf/local.h conf/local.h.orig &&  \
	    ln -s ../debian.local.h conf/local.h  \
	}
	make  \
		CC="gcc"  \
		OSHEADER="os-linux.h"  \
		CFLAGS="-O2 -g \$$(DEFS)"
	touch $(BLD)

clean ::
	test ! -d $(TMP) || su -c 'rm -rf $(TMP)'
	rm -f $(BLD)
	make clean
	rm -f deliver header uid
	test ! -f conf/local.h.orig || mv -f conf/local.h.orig conf/local.h

source ::
	test ! -f $(BLD) || make -f debian.rules clean
	cd .. && tar cf - $(PKG)-$(VER) |  \
	    gzip -9f > $(PKG)-$(VER)-$(DEB).tar.gz

diff ::
	test ! -f $(BLD) || make -f debian.rules clean
	test -d ../$(PKG)-$(VER).orig
	cd .. && diff -cNr $(PKG)-$(VER).orig $(PKG)-$(VER) |  \
	    gzip -9f > $(PKG)-$(VER)-$(DEB).diff.gz
