#!/usr/bin/make -f

package=umsdos
version=0.9
debian=1
arch = $(shell dpkg --print-architecture)

EXAMPLE_DIR=debian-tmp/usr/doc/examples/$(package)
EXAMPLES=
DOC_DIR=debian-tmp/usr/doc/$(package)
DOCS=debian.README debian.changelog

build:
	$(checkdir)
	$(MAKE) -C util CFLAGS="-O2 -g"
	touch build

clean:
	$(checkdir)
	/bin/rm -f build
	$(MAKE) -i clean
	/bin/rm -rf debian-tmp *~ 

binary:	checkroot build
	/bin/rm -rf debian-tmp
	install -d debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	sed -e '2s/@/$(version)-$(debian)/' -e '11s/#/$(arch)/' \
		debian.control > debian-tmp/DEBIAN/control
	install -d debian-tmp/sbin
	install -d debian-tmp/usr/man/man8
	install -m 644 util/umssync.8 debian-tmp/usr/man/man8
	gzip debian-tmp/usr/man/man8/umssync.8
	$(MAKE) -C util SBIN_LADR=../debian-tmp/sbin install_kit
	cp debian.copyright debian-tmp/usr/doc/copyright/$(package)
	chmod 644 debian-tmp/usr/doc/copyright/$(package)
	install -d debian-tmp/etc
	install -d debian-tmp/etc/rc.boot
	install -m 755 0umsdos 	debian-tmp/etc/rc.boot
	install -d $(DOC_DIR)
	for doc in $(DOCS) ; do \
		gzip -9vc $$doc >$(DOC_DIR)/$$doc.gz ; done
	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb

changes: binary source
	( cd ..;\
	  dchanges pgp=meskes@informatik.rwth-aachen.de \
		   $(package)_$(version)-$(debian).$(arch).deb \
		   $(package)_$(version)-$(debian).tar.gz \
		   $(package)_$(version)-$(debian).diff.gz \
	)

#Sun Apr 16 21:14:53 MET DST 1995 Christian Linhart <chris@cosy.sbg.ac.at>
#md5sum target:
#creates a file which contains names, sizes and md5sums of the files
#which are to uploaded (*.deb, *.tar.gz, *.diff.gz).
#The file gets the suffix .md5sum and is put into the parent directory.
#Because of it's dependencies this target creates the debianizing diff 
#and the binary and source packages.
md5sum: binary source diff changes
	( cd .. ; \
	  echo "MD5 checksum                            Size" ; \
	  for i in $(package)-$(version)-$(debian).{i386.deb,tar.gz,diff.gz,changes} ; do \
	        printf "%s %11d %s\n" `md5sum <$$i` `wc -c <$$i` $$i; done \
	) >../$(package)-$(version)-$(debian).md5sum


#Sun Apr 16 21:14:53 MET DST 1995 Christian Linhart <chris@cosy.sbg.ac.at>
#announce target:
#create a file containing the required part of the announce message, namely
# * the part of the changelog for the current release,
# * md5sums and sizes of files.
#The file gets the suffix .announce and is put into the parent directory.
#
#The below script is based on the following assumptions: 
# * The changelog is in the file debian.changelog,
# * The changelog entries for a release are below a line which 
#	- Starts with one or more whitespace characters,
#	- after that contains the package name followed by the version 
#	  in parentheses.
#   (anyway, for details read the regexp in the first if-statement)
# * Two lines before the above described line there is a line
#   containing the date and the package maintainer's name.
#
#Because of it's dependencies this target creates the md5sum-file, the
#debianizing diff and the binary and source packages. Thus if all works
#well, 
#	./debian.rules announce 
#creates all files necessary for uploading. 
announce: md5sum
	( perl -ne '\
		$$l2=$$l1; $$l1=$$l0; $$l0=$$_; \
		if ( /^\s+$(package)\s*\($(version)-$(debian)\)/ ) \
			{ print "$$l2$$l1"; $$copy=1 } \
		print if $$copy;' \
	  < debian.changelog ; \
	  echo ; \
	  cat ../$(package)-$(version)-$(debian).md5sum \
	) >../$(package)-$(version)-$(debian).announce
define checkdir
	test -f 0umsdos 
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)_$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)_$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)_$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)_$(version)-$(debian).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff clean checkroot announce md5sum
