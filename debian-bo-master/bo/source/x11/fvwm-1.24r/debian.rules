#! /usr/bin/make -f
#
# Last updated: Sun Aug  4 00:18:05 BST 1996 by and1000.
#
# To make the binary distribution package, the ``Debianized'' source package
# and the context diff to the original package, type `./debian.rules dist'.
# Make sure that `debian.rules' is executable before the final distribution
# is made.
#
# Invoke each target with `./debian.rules <target>'.  All targets should be
# invoked with the package root as the current directory.
#
# The `binary' target must be run as root, as it needs to install files with
# specific ownerships.  The `diff' target assumes that you have the original
# source package available, unpacked, in ../$(p)-$(v).orig, or that you have
# the previous revision of the ``Debianized'' source package and context diff
# in the parent directory.

CC = gcc
CFLAGS = -O2
LDFLAGS = -s

# The name of the package (for example, `emacs').
p = fvwm
# The version of the package (for example, `19.28').
v = 1.24r
# The Debian revision of the package (for example, `2').
d = 25
# The architecture of this build
a = $(shell dpkg --print-architecture)

build:
# Builds the binary package.
	xmkmf
	make Makefiles
	make
	touch stamp-build

clean:
# Undoes the effect of `make -f debian.rules build'.
	-make clean
	rm -f Makefile fvwm/Makefile libs/Makefile modules/*/Makefile \
	  xpmroot/Makefile
	rm -f stamp-build
	rm -rf debian-tmp

binary:
# Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	install -d -g root -m 755 -o root debian-tmp
	chmod g-s debian-tmp
	install -d -g root -m 755 -o root debian-tmp/DEBIAN
	install -d -g root -m 755 -o root debian-tmp/etc/X11/fvwm
	install -g root -m 644 -o root system.fvwmrc \
	  debian-tmp/etc/X11/fvwm/system.fvwmrc
	install -d -g root -m 755 -o root debian-tmp/usr/X11R6/bin
	install -g root -m 755 -o root -s fvwm/fvwm \
	  debian-tmp/usr/X11R6/bin/fvwm
# xpmroot is in fvwm2 now.
#	install -g root -m 755 -o root -s xpmroot/xpmroot \
#	  debian-tmp/usr/X11R6/bin/xpmroot
	install -d -g root -m 755 -o root debian-tmp/usr/X11R6/lib/X11/fvwm
	for file in FvwmAudio FvwmAuto FvwmBacker FvwmBanner FvwmClean    \
	  FvwmDebug FvwmIconBox FvwmIdent FvwmPager FvwmSave FvwmSaveDesk \
	  FvwmScroll FvwmWinList GoodStuff; \
	do \
	  install -g root -m 755 -o root -s modules/$$file/$$file \
	    debian-tmp/usr/X11R6/lib/X11/fvwm/$$file; \
	done
	( cd debian-tmp/usr/X11R6/lib/X11/fvwm \
	  && ln -s /etc/X11/fvwm/system.fvwmrc . )
	install -d -g root -m 755 -o root \
	  debian-tmp/usr/X11R6/include/X11/pixmaps
# We don't want to install the icons any more; fvwm2 has them now.
#	for file in `ls fvwm_icons/*.xpm | sed s,fvwm_icons/,,`; \
#	do \
#	  install -g root -m 644 -o root fvwm_icons/$$file \
#	    debian-tmp/usr/X11R6/include/X11/pixmaps/$$file; \
#	done
	install -d -g root -m 755 -o root debian-tmp/usr/X11R6/man/man1
	install -g root -m 644 -o root fvwm/fvwm.man \
	  debian-tmp/usr/X11R6/man/man1/fvwm.1x
# xpmroot is in fvwm2 now.
#	install -g root -m 644 -o root xpmroot/xpmroot.man \
#	  debian-tmp/usr/X11R6/man/man1/xpmroot.1x
# Module manpages from fvwm2 now.
#	for file in FvwmAudio FvwmAuto FvwmBacker FvwmBanner FvwmClean    \
#	  FvwmDebug FvwmIconBox FvwmIdent FvwmPager FvwmSave FvwmSaveDesk \
#	  FvwmScroll FvwmWinList GoodStuff; \
#	do \
#	  install -g root -m 644 -o root modules/$$file/$$file.man \
#	    debian-tmp/usr/X11R6/man/man1/$$file.1x; \
#	done
	install -d -g root -m 755 -o root debian-tmp/usr/doc/copyright
	install -g root -m 644 -o root debian.README \
	  debian-tmp/usr/doc/copyright/$(p)
	install -d -g root -m 755 -o root debian-tmp/usr/doc/examples/fvwm
	for file in `ls sample.fvwmrc/* | sed s,sample.fvwmrc/,,`; \
	do \
	  install -g root -m 644 -o root sample.fvwmrc/$$file \
	    debian-tmp/usr/doc/examples/fvwm/$$file; \
	done
	sed -e '2s/=V/$(v)/' -e '2s/=D/$(d)/' -e '3s/=A/$(a)/' debian.control \
	  > debian-tmp/DEBIAN/control
	chmod 644 debian-tmp/DEBIAN/control
	install -g root -m 644 -o root debian.conffiles \
	  debian-tmp/DEBIAN/conffiles
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb

source:
# Makes a source package.
	-test -f stamp-build && make -f debian.rules clean
	( cd .. && tar cf - $(p)-$(v) | gzip -9f > $(p)-$(v)-$(d).tar.gz )

diff:
# Makes a context diff.
	-test -f stamp-build && make -f debian.rules clean
	-test -d ../$(p)-$(v).orig -o -f ../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
	  || ( echo "Original source package is not available." ; false )
	-test -d ../$(p)-$(v).orig || make -f debian.rules orig
	( cd .. && diff -cNr $(p)-$(v).orig $(p)-$(v) | gzip -9f \
	  > $(p)-$(v)-$(d).diff.gz )
	-test -f stamp-orig \
	  && rm -rf ../$(p)-$(v).orig && rm -f stamp-orig

dist: binary source diff
# Prepares the package for distribution.

orig:
# Prepares the original package from the previous
# Debian revision source package and context diff.
	( cd .. \
	  && mkdir $(p).orig \
	  && cd $(p).orig \
	  && tar xzf ../$(p)-$(v)-`expr $(d) - 1`.tar.gz \
	  && cd $(p)-$(v) \
	  && ( zcat ../../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
	    | patch -sER -p1 ) \
	  && find . -name "*.orig" -exec rm -f {} \; \
	  && cd .. \
	  && mv $(p)-$(v) ../$(p)-$(v).orig \
	  && cd .. \
	  && rmdir $(p).orig )
	touch stamp-orig
