#! /usr/bin/make -f
#
# Last updated: Sat Dec 17 10:52:20 EST 1994 by imurdock.
#
# To make the binary distribution package, the ``Debianized'' source package
# and the context diff to the original package, type `./debian.rules dist'.
# Make sure that `debian.rules' is executable before the final distribution
# is made.
#
# Invoke each target with `./debian.rules <target>'.  All targets should be
# invoked with the package root as the current directory.
#
# The `binary' target must be run as root, as it needs to install files with
# specific ownerships.  The `diff' target assumes that you have the original
# source package available, unpacked, in ../$(p)-$(v).orig, or that you have
# the previous revision of the ``Debianized'' source package and context diff
# in the parent directory.

# The name of the package (for example, `emacs').
p = oldmitpthreads
# The version of the package (for example, `19.28').
v = 0.0
mv = 5.0.7
pv = 1.60.4
# The Debian revision of the package (for example, `2').
d = 1
a = $(shell dpkg --print-architecture)

GNU_MALLOC = malloc-930716

build:
# Builds the binary package.
	make
	touch stamp-build

clean:
# Undoes the effect of `make -f debian.rules build'.
	make clean
#	(cd locale; make programsclean)
#	rm -rf $(GNU_MALLOC)/shared
	rm -f stamp-build
	rm -rf run-tmp dev-tmp dbg-tmp pic-tmp locale-tmp pth-tmp

binary:
# Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	#
	rm -rf run-tmp dev-tmp dbg-tmp pth-tmp
	install -d run-tmp dev-tmp dbg-tmp pth-tmp
	chmod g-s run-tmp dev-tmp dbg-tmp pth-tmp
	#
	#make install TARGET_ROOTDIR=`pwd`/run-tmp REALRANLIB=ranlib install
	#strip run-tmp/lib/libc.so.$(v)
	#ln -s libc.so.$(v) run-tmp/lib/libc.so.5
	#strip run-tmp/lib/libm.so.$(mv)
	#ln -s libm.so.$(mv) run-tmp/lib/libm.so.5
	#mv -f run-tmp/usr dev-tmp
	#install -d run-tmp/usr/lib
	#cp $(GNU_MALLOC)/shared/libc/libgnumalloc.so.$(v) run-tmp/usr/lib
	#strip run-tmp/usr/lib/libgnumalloc.so.$(v)
	#ln -s libgnumalloc.so.$(v) run-tmp/usr/lib/libgnumalloc.so.5
	install -d pth-tmp/usr/lib
	cp elfshared/libpthreads.so.$(pv) pth-tmp/usr/lib
	strip pth-tmp/usr/lib/libpthreads.so.$(pv)
	ln -s libpthreads.so.$(pv) pth-tmp/usr/lib/libpthreads.so.1
	#ln -sf /lib/libc.so.$(v) dev-tmp/usr/lib/libc.so
	#ln -sf /lib/libm.so.$(mv) dev-tmp/usr/lib/libm.so
	ln -sf libpthreads.so.$(pv) pth-tmp/usr/lib/libpthreads.so
	#cp -a include dev-tmp/usr
	#rm -rf dev-tmp/usr/include/pthread*
	install -d pth-tmp/usr/include
	cp -a include/pthread* pth-tmp/usr/include/
	# ppp-comp.h and ppp_defs.h are already in the ppp package - why?
	#rm -f dev-tmp/usr/include/net/{ppp-comp.h,ppp_defs.h}
	#rm -f dev-tmp/usr/include/asm
	#rm -rf dev-tmp/usr/include/asm-*
	#cp -a include/asm-$(a) dev-tmp/usr/include
	#ln -sf asm-$(a) dev-tmp/usr/include/asm
	#install -d dbg-tmp/usr/lib
	#mv dev-tmp/usr/lib/libg.a dev-tmp/usr/lib/libc_p.a dbg-tmp/usr/lib
	#
	#install -d run-tmp/usr/doc/copyright
	#install -m 644 debian.README run-tmp/usr/doc/copyright/$(p)
	#install -d run-tmp/usr/doc/$(p)
	#install -m 644 debian.faq run-tmp/usr/doc/$(p)/FAQ
	#gzip -9f run-tmp/usr/doc/$(p)/*
	#install -d dev-tmp/usr/doc/copyright
	#ln -sf $(p) dev-tmp/usr/doc/copyright/$(p)-dev
	#ln -sf $(p) dev-tmp/usr/doc/$(p)-dev
	#install -d dbg-tmp/usr/doc/copyright
	#ln -sf $(p) dbg-tmp/usr/doc/copyright/$(p)-dbg
	#ln -sf $(p) dbg-tmp/usr/doc/$(p)-dbg
	install -d pth-tmp/usr/doc/copyright
	ln -sf $(p) pth-tmp/usr/doc/copyright/$(p)-pth
	ln -sf $(p) pth-tmp/usr/doc/$(p)-pth
	#
	#install -d run-tmp/DEBIAN
	#sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	#  -e 's/AaA/$(a)/g' debian.control-run > run-tmp/DEBIAN/control
	#sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	#  -e 's/AaA/$(a)/g' debian.shlibs-run > run-tmp/DEBIAN/shlibs
	#install -m 755 debian.preinst-run run-tmp/DEBIAN/preinst
	#install -m 755 debian.postinst-run run-tmp/DEBIAN/postinst
	#install -d dev-tmp/DEBIAN
	#sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	#  -e 's/AaA/$(a)/g' debian.control-dev > dev-tmp/DEBIAN/control
	#install -m 755 debian.preinst-dev dev-tmp/DEBIAN/preinst
	#install -d dbg-tmp/DEBIAN
	#sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	#  -e 's/AaA/$(a)/g' debian.control-dbg > dbg-tmp/DEBIAN/control
	install -d pth-tmp/DEBIAN
	sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	  -e 's/AaA/$(a)/g' debian.control-pth > pth-tmp/DEBIAN/control
	#
	chmod -R g-w run-tmp dev-tmp dbg-tmp pth-tmp
	chown -R root.root run-tmp dev-tmp dbg-tmp pth-tmp
	#dpkg --build run-tmp
	#dpkg --build dev-tmp
	#dpkg --build dbg-tmp
	dpkg --build pth-tmp
	dpkg-name -o -s ..  pth-tmp.deb

pic:
# Makes the -pic package for building boot floppies.
	test -f stamp-build || make -f debian.rules build
	rm -rf pic-tmp
	install -d pic-tmp/usr/lib
	ar cq pic-tmp/usr/lib/$p_pic.a elfshared/libc/*.o \
	  elfshared/libgcc/*.o
	install -d pic-tmp/DEBIAN
	sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	  -e 's/AaA/$(a)/g' debian.control-pic > pic-tmp/DEBIAN/control
	chmod -R g-w pic-tmp
	chown -R root.root pic-tmp
	dpkg --build pic-tmp
	dpkg-name -o -s .. pic-tmp.deb

localebin:
# Makes the locale and localedef binaries
	rm -rf locale-tmp
	install -d locale-tmp/usr/bin
	(cd locale; \
	 make programs;\
	 install -s locale ../locale-tmp/usr/bin; \
	 install -s localedef ../locale-tmp/usr/bin;\
	)
	install -d locale-tmp/DEBIAN
	sed -e 's/VvV/$(v)/g' -e 's/DdD/$(d)/g' \
	  -e 's/AaA/$(a)/g' debian.control-locale > locale-tmp/DEBIAN/control
	install -d locale-tmp/usr/doc/copyright
	ln -sf $(p) locale-tmp/usr/doc/copyright/localebin
	chmod -R g-w pic-tmp
	chown -R root.root pic-tmp
	dpkg --build locale-tmp
	dpkg-name -o -s .. locale-tmp.deb

source:
# Makes a source package.
	-test -f stamp-build && make -f debian.rules clean
	( cd .. && tar cf - $(p)-$(v) | gzip -9f > $(p)_$(v)-$(d).tar.gz )

# The diff and orig targets was removed from debian.rules because
# the original libc 4.6.27 has been removed from FTP repositories.

diff:
# Makes a context diff.
	-test -f stamp-build && make -f debian.rules clean
	-test -d ../$(p)-$(v).orig -o -f ../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
	  || ( echo "Original source package is not available." ; false )
	-test -d ../$(p)-$(v).orig || make -f debian.rules orig
	( cd .. && diff -uNr $(p)-$(v).orig $(p)-$(v) | gzip -9f \
	  > $(p)_$(v)-$(d).diff.gz )
	-test -f stamp-orig \
	  && rm -rf ../$(p)-$(v).orig && rm -f stamp-orig

FILES = $(p)_$(v)-$(d).tar.gz $(p)_$(v)-$(d).diff.gz \
	$(p)_$(v)-$(d)_$(a).deb $(p)-dev_$(v)-$(d)_$(a).deb \
	$(p)-dbg_$(v)-$(d)_$(a).deb $(p)-pic_$(v)-$(d)_$(a).deb \
	$(p)-pth_$(v)-$(d)_$(a).deb \
	localebin_$(v)-$(d)_$(a).deb

changes:
# Prepares the checksums and changes files.
	( cd .. && \
	  dchanges -n -e -p ce=$(p)-$(v)/debian.changes $(FILES) )

dist: binary pic localebin source diff changes
# Prepares the package for distribution.

orig:
# Prepares the original package from the previous
# Debian revision source package and context diff.
#	( cd .. \
#	  && mkdir $(p).orig \
#	  && cd $(p).orig \
#	  && tar xzf ../$(p)-$(v)-`expr $(d) - 1`.tar.gz \
#	  && cd $(p)-$(v) \
#	  && ( zcat ../../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
#	    | patch -sER -p1 ) \
#	  && find . -name "*.orig" -exec rm -f {} \; \
#	  && cd .. \
#	  && mv $(p)-$(v) ../$(p)-$(v).orig \
#	  && cd .. \
#	  && rmdir $(p).orig )
#	touch stamp-orig
