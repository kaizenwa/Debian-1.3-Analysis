#! /usr/bin/make -f
#
# Last updated: Sat Dec 17 10:52:20 EST 1994 by imurdock.
#
# To make the binary distribution package, the ``Debianized'' source package
# and the context diff to the original package, type `./debian.rules dist'.
# Make sure that `debian.rules' is executable before the final distribution
# is made.
#
# Invoke each target with `./debian.rules <target>'.  All targets should be
# invoked with the package root as the current directory.
#
# The `binary' target must be run as root, as it needs to install files with
# specific ownerships.  The `diff' target assumes that you have the original
# source package available, unpacked, in ../$(p)-$(v).orig, or that you have
# the previous revision of the ``Debianized'' source package and context diff
# in the parent directory.

# The name of the package (for example, `emacs').
p = libc4
# The version of the package (for example, `19.28').
v = 4.6.27
# The Debian revision of the package (for example, `2').
d = 15
arch = i386

build:
# Builds the binary package.
	make
	touch stamp-build

clean:
# Undoes the effect of `make -f debian.rules build'.
	make clean
	rm -f stamp-build
	rm -rf run-tmp dev-tmp

binary:
# Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	#
	rm -rf run-tmp dev-tmp
	install -d run-tmp dev-tmp
	chmod g-s run-tmp dev-tmp
	#
	install -d run-tmp/DEBIAN
	install -d run-tmp/lib
	install -d run-tmp/usr/lib/i486-linuxaout
	install -d dev-tmp/usr/i486-linuxaout/lib
	( cd jump/libc ; \
	  make install TARGET_SO_DIR=../../run-tmp/lib \
	               TARGET_LIB_DIR=../../dev-tmp/usr/i486-linuxaout/lib )
	( cd jump/libm ; \
	  make install TARGET_LIBM_SO_DIR=../../run-tmp/lib \
	               TARGET_LIB_DIR=../../dev-tmp/usr/i486-linuxaout/lib )
	( cd jump/libcurses ; \
	  make install TARGET_SO_DIR=../../run-tmp/lib \
	               TARGET_LIB_DIR=../../dev-tmp/usr/i486-linuxaout/lib )
	( cd jump/libdb ; \
	  make install TARGET_SO_DIR=../../run-tmp/usr/lib/i486-linuxaout \
	               TARGET_LIB_DIR=../../dev-tmp/usr/i486-linuxaout/lib )
	make install.static TARGET_LIB_DIR=../dev-tmp/usr/i486-linuxaout/lib
	#make install.debug TARGET_LIBEXTRA_DIR=../debian-tmp/usr/i486-linuxaout/lib
	ldconfig -n run-tmp/lib run-tmp/usr/i486-linuxaout/lib
	ln -s libc.a dev-tmp/usr/i486-linuxaout/lib/libg.a
	ln -s libc.sa dev-tmp/usr/i486-linuxaout/lib/libg.sa
	make install.profile TARGET_LIBEXTRA_DIR=../dev-tmp/usr/i486-linuxaout/lib
	cp -a include dev-tmp/usr/i486-linuxaout
	rm -rf dev-tmp/usr/i486-linuxaout/include/asm-*
	cp -a include/asm-i386 dev-tmp/usr/i486-linuxaout/include
	#
	install -d run-tmp/usr/doc/copyright
	install -m 644 debian.README run-tmp/usr/doc/copyright/$(p)
	install -d run-tmp/usr/doc/$(p)
	install -m 644 debian.faq run-tmp/usr/doc/$(p)/FAQ
	gzip -9f run-tmp/usr/doc/$(p)/*
	install -d dev-tmp/usr/doc/copyright
	ln -sf $(p) dev-tmp/usr/doc/copyright/$(p)-dev
	ln -sf $(p) dev-tmp/usr/doc/$(p)-dev
	#
	install -d run-tmp/DEBIAN
	sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	  debian.control-run > run-tmp/DEBIAN/control
	install -m 755 debian.postinst-run run-tmp/DEBIAN/postinst
	install -m 755 debian.postrm-run run-tmp/DEBIAN/postrm
	install -d dev-tmp/DEBIAN
	sed -e 's/VvV/$(v)/g' -e 's/MmM/$(mv)/g' -e 's/DdD/$(d)/g' \
	  debian.control-dev > dev-tmp/DEBIAN/control
	install -m 755 debian.preinst-dev dev-tmp/DEBIAN/preinst
	#
	chmod -R g-w run-tmp dev-tmp
	chown -R root.root run-tmp dev-tmp
	dpkg --build run-tmp
	dpkg --build dev-tmp
	mv run-tmp.deb ../$(p)-$(v)-$(d).$(arch).deb
	mv dev-tmp.deb ../$(p)-dev-$(v)-$(d).$(arch).deb

source:
# Makes a source package.
	-test -f stamp-build && make -f debian.rules clean
	( cd .. && tar cf - $(p)-$(v) | gzip -9f > $(p)-$(v)-$(d).tar.gz )

# The diff and orig targets was removed from debian.rules because
# the original libc 4.6.27 has been removed from FTP repositories.

diff:
## Makes a context diff.
#	-test -f stamp-build && make -f debian.rules clean
#	-test -d ../$(p)-$(v).orig -o -f ../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
#	  || ( echo "Original source package is not available." ; false )
#	-test -d ../$(p)-$(v).orig || make -f debian.rules orig
#	( cd .. && diff -uNr $(p)-$(v).orig $(p)-$(v) | gzip -9f \
#	  > $(p)-$(v)-$(d).diff.gz )
#	-test -f stamp-orig \
#	  && rm -rf ../$(p)-$(v).orig && rm -f stamp-orig

FILES = $(p)-$(v)-$(d).tar.gz $(p)-$(v)-$(d).$(arch).deb \
	$(p)-dev-$(v)-$(d).$(arch).deb

changes:
# Prepares the checksums and changes files.
	( cd .. && \
	  dchanges -n -e -p ce=$(p)-$(v)/debian.changes $(FILES) )

dist: binary pic source changes
# Prepares the package for distribution.

orig:
# Prepares the original package from the previous
# Debian revision source package and context diff.
#	( cd .. \
#	  && mkdir $(p).orig \
#	  && cd $(p).orig \
#	  && tar xzf ../$(p)-$(v)-`expr $(d) - 1`.tar.gz \
#	  && cd $(p)-$(v) \
#	  && ( zcat ../../$(p)-$(v)-`expr $(d) - 1`.diff.gz \
#	    | patch -sER -p1 ) \
#	  && find . -name "*.orig" -exec rm -f {} \; \
#	  && cd .. \
#	  && mv $(p)-$(v) ../$(p)-$(v).orig \
#	  && cd .. \
#	  && rmdir $(p).orig )
#	touch stamp-orig
