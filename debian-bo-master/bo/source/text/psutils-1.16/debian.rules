#!/usr/bin/make -f

package=psutils
version=1.16
debian=3
arc := $(shell dpkg --print-architecture)

build:
	$(checkdir)
	chmod +x ./maketext
	$(MAKE)
	(cat debian.README; echo -e '\n\n'; cat LICENSE) >debian-tmp.copyright
	touch build

clean:
	$(checkdir)
	-rm -f build
	-$(MAKE) -i realclean
	-rm -rf debian-tmp *~ debian-tmp.copyright *.orig #*#

binary:		checkroot build
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/{doc/copyright,bin,man/man1,lib/psutils}
	sed -e 's/=V/$(version)-$(debian)/' -e 's/=A/$(arc)/' \
		debian.control > debian-tmp/DEBIAN/control
	$(MAKE) prefix=debian-tmp/usr install
	cp debian-tmp.copyright debian-tmp/usr/doc/copyright/psutils
	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp
	mv debian-tmp.deb ../psutils-$(version)-$(debian).$(arc).deb

define checkdir
	test -f pstops.c
endef

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)-$(version)-$(debian).tar $(package)-$(version)/ && \
	gzip -9vf $(package)-$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)-$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)-$(version)-$(debian).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"
