#! /usr/bin/make -f
#
# To make the distributed dpkg archive, and the ``Debianized'' source
# package, type `./debian.rules dist'.  Make sure that `debian.rules' is
# executable before the final distribution is made.
#
# Invoke each target with `./debian.rules <target>'.  All targets should be
# invoked with the package root as the current directory.

p = german
v = 2
d = 5

build:
# Builds the binary package.
	make 
	touch stamp-build

clean:
# Undoes the effect of `make -f debian.rules build'.
	make clean
	/bin/rm -f stamp-build

binary:
	test -f build || make -f debian.rules build
	@-[ "`whoami`" != root ] && \
		echo "Enter the root password to build the .deb file"
	@su -c "umask 22; exec make -f debian.rules binary-root"

binary-root:
# Makes a binary package.
	test -f stamp-build || make -f debian.rules build
	install -d -g root -m 755 -o root i-tmp
	install -d -g root -m 755 -o root w-tmp
	chmod g-s i-tmp
	chmod g-s w-tmp
	install -d -g root -m 755 -o root i-tmp/DEBIAN
	install -d -g root -m 755 -o root i-tmp/usr
	install -d -g root -m 755 -o root i-tmp/usr/lib
	install -d -g root -m 755 -o root i-tmp/usr/lib/ispell
	install -d -g root -m 755 -o root i-tmp/usr/doc
	install -d -g root -m 755 -o root i-tmp/usr/doc/igerman
	install -d -g root -m 755 -o root i-tmp/usr/doc/copyright
	install -d -g root -m 755 -o root w-tmp/DEBIAN
	install -d -g root -m 755 -o root w-tmp/usr
	install -d -g root -m 755 -o root w-tmp/usr/dict
	install -d -g root -m 755 -o root w-tmp/usr/doc
	install -d -g root -m 755 -o root w-tmp/usr/man
	install -d -g root -m 755 -o root w-tmp/usr/man/man5
	install -d -g root -m 755 -o root w-tmp/usr/doc/wgerman
	install -d -g root -m 755 -o root w-tmp/usr/doc/copyright
	install -o root -g root -m 0644 deutsch.hash i-tmp/usr/lib/ispell/german.hash
	install -o root -g root -m 0644 deutsch.aff i-tmp/usr/lib/ispell/german.aff
	install -o root -g root -m 0644 deutsch w-tmp/usr/dict/german
	(cd i-tmp/usr/lib/ispell; ln -sf german.aff deutsch.aff; \
	  ln -sf german.hash deutsch.hash;)
	(cd w-tmp/usr/dict; ln -sf german deutsch)
	install -o root -g root -m 0644 words.5 w-tmp/usr/man/man5
	gzip w-tmp/usr/man/man5/words.5
	#
	sed -e 's/@V@/$(v)-$(d)/' \
		igerman.control > control
	install -g root -m 644 -o root control \
	  i-tmp/DEBIAN/control
	/bin/rm control
	install -g root -m 755 -o root igerman.postinst \
	  i-tmp/DEBIAN/postinst
	install -g root -m 755 -o root igerman.prerm \
	  i-tmp/DEBIAN/prerm
	install -g root -m 644 -o root debian.changelog \
	  i-tmp/usr/doc/igerman
	gzip i-tmp/usr/doc/igerman/debian.changelog
	install -g root -m 644 -o root debian.readme \
	  i-tmp/usr/doc/igerman/
	gzip i-tmp/usr/doc/igerman/debian.readme
	install -g root -m 644 -o root igerman.copyright \
	  i-tmp/usr/doc/copyright/igerman
	dpkg --build i-tmp && dpkg-name -o -s .. i-tmp.deb
	sed -e 's/@V@/$(v)-$(d)/' \
		wgerman.control > control
	install -g root -m 644 -o root control \
	  w-tmp/DEBIAN/control
	/bin/rm control
	install -g root -m 755 -o root wgerman.postinst \
	  w-tmp/DEBIAN/postinst
	install -g root -m 755 -o root wgerman.prerm \
	  w-tmp/DEBIAN/prerm
	install -g root -m 644 -o root debian.changelog \
	  w-tmp/usr/doc/wgerman
	gzip w-tmp/usr/doc/wgerman/debian.changelog
	install -g root -m 644 -o root debian.readme \
	  w-tmp/usr/doc/wgerman/
	gzip w-tmp/usr/doc/wgerman/debian.readme
	install -g root -m 644 -o root wgerman.copyright \
	  w-tmp/usr/doc/copyright/wgerman
	dpkg --build w-tmp && dpkg-name -o -s .. w-tmp.deb
	rm -rf i-tmp w-tmp

source: clean
# Makes a source package.
	-test -f stamp-build && make -f debian.rules clean
	( cd .. && \
	  tar cf hk$(p)_$(v)-$(d).tar hk$(p)_$(v) && \
	  gzip -9f hk$(p)_$(v)-$(d).tar )

diff:	clean
	cd .. && \
	(diff -ruN hk$(p)_$(v).orig hk$(p)_$(v) \
	 >hk$(p)_$(v)-$(d).diff; [ $$? = 1 ]) && \
	gzip -9vf hk$(p)_$(v)-$(d).diff

new:
	( perl -ne '\
		$$l2=$$l1; $$l1=$$l0; $$l0=$$_; \
		if ( /^\s+hk$(p)\s*\($(v)-$(d)\)/ ) \
			{ print "$$l2$$l1"; $$copy=1 } \
		print if $$copy;' \
	< debian.changelog ; \
	) >../hk$(p)_$(v)-$(d).new

changes: binary source diff new
	( cd ..; \
	  dchanges ce=hk$(p)_$(v)-$(d).new \
		   i$(p)_$(v)-$(d)_all.deb \
		   w$(p)_$(v)-$(d)_all.deb \
		   hk$(p)_$(v)-$(d).tar.gz \
		   hk$(p)_$(v)-$(d).diff.gz \
        )


