#!/usr/bin/make -f
#
# modified from sample debian.rules file for GNU Hello by Ian Jackson.

package=mgt
version=2.31
debian=1

binfiles=mailgo mgt mgt2short wrapmgt
libfiles=Rules Sample.01 Sample.02
manfiles=mailgo.6 mgt.6 mgt2short.6 wrapmgt.6
docfiles=Prop.lst README Smart-Go.def

# The next section may have to be extensively modified

build:
	$(checkdir)
	$(MAKE) CFLAGS=-O2 LDFLAGS=-s
	touch build

clean:
	$(checkdir)
	-rm -f build
	-$(MAKE) -i clean
	-rm -rf debian-tmp *~

binary:		checkroot build
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	sed -e '2s/=/$(version)-$(debian)/; \
		3s/=/$(shell dpkg --print-architecture)/;' \
	    debian.control > debian-tmp/DEBIAN/control
	install -d debian-tmp/usr/games
	cp $(binfiles) debian-tmp/usr/games
	install -d debian-tmp/usr/lib/games/mgt
	cp $(libfiles) debian-tmp/usr/lib/games/mgt
	install -d debian-tmp/usr/man/man6
	cp *.6 debian-tmp/usr/man/man6
	install -d debian-tmp/usr/doc/$(package)
	cp $(docfiles) debian-tmp/usr/doc/$(package)
	cp debian.README debian-tmp/usr/doc/copyright/$(package)
	chown -R root.root debian-tmp
	chmod 755 debian-tmp/usr/games/*
	chmod 644 debian-tmp/usr/{lib/games/mgt/*,man/man6/*,doc/mgt/*}
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb
#	mv debian-tmp.deb ../$(package)-$(version)-$(debian).$(arch).deb

define checkdir
	test -f $(package).c
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)_$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)_$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)_$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)_$(version)-$(debian).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary source diff clean checkroot
