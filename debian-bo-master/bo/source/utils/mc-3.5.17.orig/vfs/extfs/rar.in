#!/bin/sh
RAR=rar

mcrarfs_list ()
{
eval $RAR vt -c- $1 | @AWK@ -v uid=${UID-0} '
BEGIN {
        do {
                getline
        } while( $0 !~ /^\-+$/ )
}
/^$/ { next }
/^\-+$/ { exit 0 }
{
        name = $1
        if( name ~ /^\*/ )
                name = substr(name, 2)
        getline
        getline typ
        split(typ, a)
        if( a[1] == "DOS" ) {
                if( index($6, "D") != 0 )
                        attr = "d"
                else
                        attr = "-"
                if( index($6, "R") != 0 )
                        attr = attr "r--r--r--"
                else
                        attr = attr "rw-r--r--"
                owner = uid
                group = 0
        }

        if( a[1] == "Unix" ) {
                attr = $6
                getline ow
                split(ow, b)
                owner = b[4]
                group = b[5]
        }

        split($4, dd, "-")
        printf("%s   1 %-8s %8-s %8d %2s-%2s-%2s %-s %-s\n", attr, owner, group, $1, dd[2], dd[1],\
 dd[3], $5, name)
        next
}' 2>/dev/null
}

mcrarfs_copyout ()
{   
    # rar doesn't know how to extract a file with a new name,
    # so we have to do this:
    eval $RAR x -o+ $1 $2 /tmp/ </dev/null 2>&1 1>/dev/null
    mv -f /tmp/$2 $3 2>/dev/null
}

case "$1" in
  list) mcrarfs_list $2; exit 0;;
  copyout) mcrarfs_copyout $2 $3 $4; exit 0;;
esac
exit 1
