#!/usr/bin/make -f
# debian.rules file for statserial-1.1
# Based on the sample debian.rules file written by Ian Jackson.
# Written by Christian Linhart in 1995 and 1996.
# I hereby place this file in the public domain.

package=statserial
version=1.1
debian=13
priority=extra
section=admin
urgency=Low

arch=$(shell dpkg --print-architecture)
ctrlfilter=sed -e '2s/=/$(version)-$(debian)/; 3s/=/$(arch)/;' 
name=$(package)_$(version)-$(debian)
binary=$(name)_$(arch).deb
source=$(name).tar.gz
diff=$(name).diff.gz
changes=$(name).changes

EXAMPLE_DIR=debian-tmp/usr/doc/examples/$(package)
EXAMPLES=phone_log
DOC_DIR=debian-tmp/usr/doc/$(package)
DOCS=README debian.README debian.changelog ChangeLog
BIN_DIR=debian-tmp/usr/bin
MAN_DIR=debian-tmp/usr/man

build:
	$(checkdir)
	$(MAKE) 
	touch build

clean:
	$(checkdir)
	-rm -f build
	-$(MAKE) -i clean
	-rm -rf debian-tmp *~ 

binary:		checkroot build
	#
	#*** Debian stuff ***
	#
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	$(ctrlfilter) debian.control > debian-tmp/DEBIAN/control
	#
	#*** Program ***
	#
	install -d debian-tmp/usr/bin
	install -m 755 statserial debian-tmp/usr/bin/statserial
	install -d debian-tmp/usr/man/man1
	install -m 644 statserial.1 debian-tmp/usr/man/man1/statserial.1
	cp debian.copyright debian-tmp/usr/doc/copyright/$(package)
	#
	#*** Examples ***
	#
	install -d $(EXAMPLE_DIR)
	for example in $(EXAMPLES) ; do \
		gzip -9vc $$example >$(EXAMPLE_DIR)/$$example.gz ; done
	#
	#*** DOCS ***
	#
	install -d $(DOC_DIR)
	for doc in $(DOCS) ; do \
		gzip -9vc $$doc >$(DOC_DIR)/$$doc.gz ; done
	#
	#*** make deb file ***
	#
	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb

define checkdir
	test -f statserial.c
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(name).tar $(package)_$(version) && \
	gzip -9vf $(name).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)_$(version).orig $(package)_$(version) \
	 >$(name).diff; [ $$? = 1 ]) && \
	gzip -9vf $(name).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"

#Below is for maintainer only (automatic announce & upload)
#Usage:
#	1. make all files (including the changes file):
#		as root: ./debian.rules allfiles
#	2. test the package. if not ok correct it and go back to 1.
#	3. announce & prepare for upload (put in the uploadqueue directory)
#		as chris: ./debian.rules announce


announceaddr=debian-devel@lists.debian.org

checkmaintainerhost:
	test baer.christian.linhart.nodomain = "`hostname -fqdn`"

announce: checkmaintainerhost upload
	( cat ../$(changes) ; echo ; echo -- ; cat ~chris/.signature ) \
		>../$(name).announce
	vi ../$(name).announce
	su chris -c 'mail $(announceaddr) \
		-s "uploading $(name)" <../$(name).announce'

upload: checkmaintainerhost
	su chris -c 'cp ../$(binary) ../$(diff) ../$(source) ../$(changes) \
		~chris/Debian/uploadqueue'

allfiles: binary source diff
	su chris -c "./debian.rules changes"
	
changes: ../$(binary) ../$(source) ../$(diff)
	#extract change info from changelog
	tmp=/tmp/$$$$ ; \
	perl -ne '\
		if ($$copy) {s/^\t//;print}; \
		$$copy=1 if ( /^\s+$(package)\s*\($(version)-$(debian)\)/ )' \
	< debian.changelog >$$tmp ; \
	cd .. ; dchanges -n ce=$$tmp urg=$(urgency) \
		pgp="Christian Linhart <chris@cosy.sbg.ac.at>" \
		s=$(section) p=$(priority) $(binary) $(source) $(diff) ; \
	rm $$tmp

.PHONY: binary source diff clean checkroot changes
