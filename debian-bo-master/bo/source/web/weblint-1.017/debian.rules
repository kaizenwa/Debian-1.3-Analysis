#!/usr/bin/make -f

package=weblint
version=1.017
debian=1
arch=all

sources = weblint
programs = weblint
manpages = weblint.1
debian_files = debian.control
support_files = weblintrc rc.new
cleaned_files = 

# various path manglement
BINDIR =  debian-tmp/usr/bin
MANDIR = debian-tmp/usr/man/man1
DOCDIR = debian-tmp/usr/doc

# Since Laziness is a virtue, let's make things a little easier for your 
# humble package maintainer.
HOSTNAME = $(shell hostname)
MAINTAINERHOSTNAME = perv


build:  Makefile $(sources)
	make
	touch build
ifeq ($(HOSTNAME), $(MAINTAINERHOSTNAME))
	make test
endif


clean:
	-$(MAKE) clean
	-rm -rf debian-tmp build *~ $(cleaned_files)

binary:	checkroot build $(debian_files)
	-rm -rf debian-tmp
	install -d debian-tmp/DEBIAN
	install -d $(BINDIR)
	install -d $(MANDIR)
	install -d $(DOCDIR)/copyright
	install -d $(DOCDIR)/$(package)

	make install BINDIR=$(BINDIR) MANDIR=$(MANDIR)

	$(foreach file,$(debian_files),\
	  perl -pe 's/=version=/$(version)-$(debian)/;' $(file) > debian-tmp/DEBIAN/$(subst debian.,,$(file));)
	chown -R root.root debian-tmp/DEBIAN
	install -g root -o root -m 644 debian.README $(DOCDIR)/copyright/$(package)
	cp -R $(support_files) $(DOCDIR)/$(package)
	chmod -R a+r $(DOCDIR)/$(package)
	gzip -9rf $(DOCDIR)/$(package) || true
	dpkg --build debian-tmp && dpkg-name -o -s .. debian-tmp.deb

# Below here is fairly generic really

source:	clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)_$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)_$(version)-$(debian).tar
 
diff:	clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	>$(package)_$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)_$(version)-$(debian).diff

admin:
	chmod +x debian.extract-changes.pl
	./debian.extract-changes.pl $(package) $(version) Debian $(debian) > tmp-admin
	cd .. ; dchanges -n ce=$(package)-$(version)/tmp-admin \
	    $(package)_$(version)-$(debian)_$(arch).deb \
	    $(package)_$(version)-$(debian).diff.gz \
	    $(package)_$(version)-$(debian).tar.gz
	rm -f tmp-admin

dist: binary source diff admin

checkroot:
	test root = "`whoami`"

.PHONY: binary source diff clean checkroot admin dist

