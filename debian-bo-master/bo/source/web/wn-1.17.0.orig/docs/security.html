<html>
<head>
<title>WN Security</title>
</head>
<body>
<!-- pnuts --> <a href="index_desc.html">[Previous]</a> <a href="search.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
<hr size="4">
<!-- #WN_start -->
<h2 align="center">WN Security</h2>
<hr size="4">

A great deal of effort has gone into attempting to make WN as secure
as possible.  Security has received the highest priority in all design
decisions.  This is not grounds for WN maintainers to feel they can
lessen their vigilance, however.  The first thing you should be aware
of is that there is a trade-off between security and functionality.
You can have high security and restricted functionality or lower
security with greater functionality, or something in between.  WN is
designed to let the maintainer choose the point on this continuum he
or she is comfortable with.  This document tries to discuss the
various options you as a maintainer will have and what the
implications of your choices are.
<p>

First, it is important to understand possible threats to the integrity
of a system running the WN server.  There are two types of threat
which this document addresses separately: (1) external, from a client
or purported client on a remote host, and (2) local, from a user with
an account on the server host. <p>

After reading this section you may wish to look at the section
on <a href="index_desc.html#file_owner">file ownership and permissions.</a>
<p>

<h3>4.1 External Threats</h3>

The maintainer's objective is to prevent any unauthorized access to
(or alteration of) files on the host system.  Scripts or programs run
on the server with the CGI protocols cause special problems and are
discussed separately below.  If you do not need to use any executable
scripts you should run the server with the <a
href="appendixA.html#e_opt">-e option.</a> The -e option disallows any
attempt to execute a command on your server and does not allow any
data sent by a client  even to be written to a temporary disk file.  In
this situation the key to WN security is twofold: no document
is served without explicit permission from the maintainer and nothing
is written to disk on the server except the log file.<p>

The basic philosophy of WN security is that by default no client
requests are granted.  Permission to serve a document must be
explicitly granted by the maintainer.  The WN server keeps a small
data base in each directory of its data hierarchy which contains
information about files to be served from that directory.  In
particular no document can be served unless explicit permission to
serve it is given in such a data base.
<p>

<i>[For more information on these
data base files the <a href="overview.html">
Overview Chapter</a> is a good place to start.  These files are very
easy to create and maintain; see the chapter on <a href="index_desc.html">
creating a data hierarchy.</a>]</i>
<p>

Despite this strong security foundation several additional steps are
prudent.  The most important is that the maintainer must assure that
no untrusted person has write access to any part of the WN hierarchy.
For example an "incoming" anonymous ftp directory should <i>never</i>
be part of a WN hierarchy (better yet don't have one at all), because
an attacker might be able to put a data base there granting illicit
access to some documents on the server system for which the user id
running the server has read permission.  There are several defenses
against such a "counterfeit" data base and we discuss them next.<p>

<h4>4.1.1 Protecting your <i>index.cache</i> files</h4>

All security control for the WN server resides in the per directory
data base files (these files have the default name
<i>index.cache</i>).  Consequently it is extremely important to
guarantee their integrity.  There are several command line options for
the server which help protect against counterfeit index.cache files.
<p>

<a href="appendixA.html#t_opt">The -t and -T options.</a> These options
allow you to specify a trusted owner or group owner (not both)
for index.cache files.  To do this use the "-t uid#" or "-T gid#"
option to wn or swn.  When invoked with only the -t argument (or the
-T argument) wn or swn will not serve a document unless the
index.cache file listing it has the prescribed owner or gid.  This
uid# or gid# should be that of the maintainer <i>not</i> the user id
under which wn or swn runs.  Indeed, for security reasons if the
server has been started as root and changed to another uid it
will refuse to use an index.cache file whose owner is the uid under
which it is running.  If on your server all index.cache files are
created by a single user or a single group I strongly recommend using
the -t or -T option.  <p>

This added security is weakened somewhat if you use the <a
href="appendixA.html#u_opt">-u option</a> which allows index.cache
files owned by untrusted users, but only permits them to grant access
to files owned by the same user as the index.cache file.  This option
might be appropriate if you permit users to have their own homepage on
your server.  It would allow users to serve documents which they own
but no others.  If both the -u and the -t argument are used the -u
takes effect except the trusted user specified with the -t option is
exempt from its restrictions.
<p>

When the server is run it must assume the permissions of some user on
the host.  Which user is determined when you run the "configure" perl
script or by defining USER_ID in config.h.  It is important this
USER_ID have as few permissions as possible. On many systems there is
a user called "nobody" with minimal permissions.  The numeric user_id
of "nobody" is a good choice and is the default choice of the WN
configure script. Of course the server must have read permission on
all the files served but it should not have write permission for any
directory or file other than its log files.  If the syslog option for
logging is enabled there is not even any need for write permission on
a log file.  A good practice is to have all the files in your
hierarchy which you intend to serve be owned by the maintainer or
their creator.  They should be world readable (assuming they are for
general consumption) but with restricted write permission.  The files
in your hierarchy should <em>not</em> be owned by the user id under
which WN will run. <p>


WN does not by default use the chroot system call to further
restrict the files which the server can access.  Doing so would
enhance security at the expense of extra work for the maintainer.  The
effect of this is to prevent the server from even internally accessing
any file which is not in your data directory.  If you are especially
concerned about security you may wish to run one of the public domain
TCP wrappers in conjunction with WN which will allow you to use
the chroot system call.  This can simultaneously enhance security for
other TCP services like anonymous ftp. <p>


<h4>4.1.2 CGI programs and scripts</h4>

Enabling the use of scripts or programs run on the server greatly
enhances its functionality but also increases the potential risk of an
attack.  Many things which on other servers can only be done with
CGI scripts are built-in features of WN and hence entail much less
risk than they would as CGI scripts.  These include
<a href="click.html">imagemaps</a>, a
variety of <a href="search.html">document searches,</a> and serving
<a href="parse.html#if">conditional text</a>
based on information in the client supplied headers.  If your needs
can be met with these features then you can disable CGI with the
-e option and greatly improve your security.
<p>

However, there are many needs which can only be met by scripts.
The greatest danger in their use is that even though the script is under
the control of the maintainer, the arguments passed to it can be set
by a potential attacker.  WN supports the CGI  or "Common Gateway
Interface" protocol (see the <a href="cgi.html">chapter on CGI</a>
in this guide) for executing scripts.
Under this protocol there are three ways by which
arguments are passed to scripts.  The first of these is used when
processing HTML forms which use the GET method.  Under this method all
arguments are put in environment variables and the script must extract
them from the environment.  Moreover, they have been placed in a URL
encoded format by the browser and must be decoded by the script.  Thus
if the request is of type GET, the arguments are examined to see if
they contain an '='.  If they do, it is assumed that this is a CGI
form response (something like name=John&toppings=pepperoni).  In this
case the script is executed with no arguments and the argument string
is placed in an environment variable where the script can read it.
This is fairly safe from the server point of view but the script
writer must exercise great care.
<p>

The second method is for HTML forms using the POST method.  In this
case everything posted by the client (in URL-encoded form) must be
sent to the standard input of the CGI script.  Thus if the request is
of type POST, information is read from the client and put in a
temporary file on disk.  Then the script is executed with no arguments
and its standard input comes from this file.  Security is the
responsibility of the script writer. It is not so dangerous to have
arguments come from standard input but the script writer must still
exercise care.
<p>

Finally if the GET request has arguments but no '=' it is assumed to
be an ISINDEX type request and the script should be executed with the
given arguments.  While the CGI specification does not permit the
altering of arguments, it does say that if the arguments pose any
security problems it is permissible to put the string in an
environment variable and execute the script with no arguments, just as
in the CGI forms case described above.  WN takes a very strict view on
this subject and considers any characters other than space and
alphanumeric characters as a security problem.  Accordingly, if it
finds any other character in an argument it will put all arguments in
the appropriate environmental variable and run the script with no
command line arguments.
<p>

Again let me say <b>the script writer must exercise great care.</b> I
can't emphasize this too strongly.  When you run a CGI script the
server almost completely absolves itself of security responsibility
and dumps that responsibility on the script writer.  Most authors of
freely distributed CGI scripts are not fully cognizant of potential
security holes they may open up.  Running insecure scripts created
locally or obtained from Usenet postings is almost certainly the
single greatest risk to a WN server site.  To find out more about
writing secure CGI scripts I strongly recommend that you read the
relevant sections of Lincoln Stein's <a
href="http://www-genome.wi.mit.edu/WWW/faqs/www-security-faq.html">
WWW Security FAQ</a> and the 
<a href="http://www.cerf.net/~paulp/cgi-security/">CGI security
page</a> maintained by Paul Phillips.

<h3>4.2 Internal Threats</h3>

Whenever untrusted users have accounts on a system there is risk
involved.  The objective of WN is to insure that running the
server does not increase this risk.  If the server is wisely managed,
I believe this goal can be achieved.  Here are some guidelines. <p>

If it is possible make sure that no untrusted user has write access to
any part of your WN hierarchy.  As mentioned above an attacker with
write access to your hierarchy can create an index.cache file which will
give access to anything on your server which is readable by the user id
under which WN runs.  Even worse, she can create
a shell script and a index.cache file permitting it to be executed, so
it can be executed with all the permissions of that user id.  A good
rule of thumb is:
<blockquote>
<i>Always assume that everyone with write access to any
part of your data hierarchy has all the permissions of the userid
under which your server runs!</i>
</blockquote>
This should not be true if you are using some of the command line
options described above, but it is good practice to behave as if it
were true.
<p>

Sometimes it is not possible or desirable to deny write access to your
WN hierarchy.  For example, you may need to allow all users to
have a homepage in their home directory or in some other designated
place.  There are two important things to do in this case. <p>

The first of these is run the server with the <a
href="appendixA.html#u_opt">-u option.</a> This has the effect of
requiring that every file served (including wrappers and includes)
have the same owner as the index.cache file which grants it permission
to be served.  This means that untrusted users can only serve files
which they own.  This will prevent a user from serving /etc/passwd,
but will not prevent him from making his own copy of /etc/passwd and
serving that.

If the <a href="appendixA.html#t_opt">-t or -T option</a> is also
used then index.cache files owned by the trusted user or trusted group
are exempt from this requirement and they may grant permission to
serve any file the server can read.  For security reasons the server
will refuse to use an index.cache file which is a symbolic link to
another file.<p>

The <a href="appendixA.html#e_opt">-e or -E</a> command line options
mentioned above are also a good idea in this case, to prevent any
execution of scripts or at least restrict their execution to trusted
index.cache files. <p>

You should note that when run in its default configuration there is no
way to use <a href="access.html#ip>access files</a> or <a
href="access.html#authenticate>password authentication</a> to prevent
users on your system, who can create index.cache files, from gaining
access to files you are serving.  They can simply make a symbolic link
in their part of the hierarchy to the file you want to restrict and a
index.cache file permitting it to be served.  Since the server has
access to the restricted file it will serve it if it is listed in a
index.cache file. This simple threat can be avoided by using the -u
option described above, but the number of potential threats is quite
large.  For example, if the -e or -E option is not used a hostile user
could write a CGI script which reads the sensitive files and mails
them to himself.  In general I would strongly advise against trying to
have sensitive documents (protected by password or .access files) and
potentially hostile users on the same server.  I would also strongly
advise against allowing potentially hostile CGI scripts, executed
includes or external modules.  They can be disallowed through the use
of the <a href="appendixA.html#e_opt">-E or -e command line options.</a>
If they are not disallowed a CGI script can alter or destroy log
files.  A hostile authorization module could collect user passwords.
<p>

The -u and -E options greatly enhance security, but it is important to
keep the following principle in mind.  <i>You should assume that any
permissions you grant to the userid under which WN runs are also
granted to every user who can create an index.cache file in your data
hierarchy.</i> <p>

<h3>4.3 Password authentication and restriction by IP address</h3>

WN offers two methods of limiting access to your hierarchy or parts of
it.  See the <a href="access.html#authenticate">chapter on access
control</a> of this guide for information on how to use these
features.

These are useful for many purposes but I would not advise using them
to protect extremely sensitive information.  The first of these
methods is restriction by hostname or IP address.  It is not impossible to
spoof a server with a fake IP address, but I think it is fairly
difficult.  It is easier to use a counterfeit hostname.  For this
reason I would suggest using IP addresses rather than host names
in <a href="access.html#ip">access control files</a>.
<p>

The other method of limiting access is by password with the HTTP 1.0
Basic Authentication Scheme.  This is about as secure as using
passwords with ftp to protect information.  This scheme is flawed in
that it involves the transmission of essentially unencoded passwords
over the network.  It is relatively easy for unscrupulous people to
obtain "sniffer" software which allows eavesdropping on all local
network traffic.  This means, in particular, that it is possible to
intercept passwords of other users.
<p>

For security reasons when you use authwn or any Authorization-Module
<b>you are required to use either the <a href="appendixA.html#t_opt">
-t or -T option</a> or the <a href="appendixA.html#a_opt">-a or -A
option</a></b> when the server is run and to have the index.cache file
in the protected directory owned by the trusted user or group. This is
to guard against counterfeit authentication modules.  <p>

This particular problem is remedied by the "Digest" authentication
scheme.  Digest authentication is supported experimentally by <i>WN,</i>
but has the rather severe drawback that no publicly available clients
currently support it.  It is experimental, because I have no client
to test it and hence it has barely been tested.  I believe it will
be a standard part of HTTP 1.1 and at that time will significantly
improve security of password protected directories.
<p>

The <a href="access.html#authenticate">Authorization-Realm
directive,</a> used whenenver an authentication module is used, is to
notify the client that for any document on this server with the same
realm as this one, the same password / username combination will be
valid, so the client need not ask the user for a username and
password, but can reuse the one supplied for the first document with
this realm.  For security reasons you should always put your host
and domain name in the realm.  This may at least discourage attempts
at other sites to forge your realm in order to collect user passwords.
Your users should also be warned never to enter their password if the
realm displayed when they are prompted for a password contains a
different hostname than the one in the URL they are trying to access.
<p>

Both Basic authentication and access control by IP address become much
more vulnerable if the potential attack comes from users who can
create index.cache files for another part of your server's data
hierarchy.  I would recommend against trying to use either to protect
information from users with home pages on your server.
<p>

If no potentially hostile users can create servable documents on your
system the mechanisms described above provide protection adequate for
many purposes.  If I were an information provider selling access to a
collection of information on my server, I would be comfortable using
the numeric IP address to limit access to my paying customers.  On the
other hand I would not want any of these mechanisms used to protect my
bank records.
<p>

<h3>4.4 Some Recommended Security Configurations</h3>

This a list of possible ways you might configure your server by setting
values in config.h and using command line arguments.  It assumes that
you are running either <i>swn</i> or <i>wn</i> on the privileged port 80
and that the default value of USERID and GROUPID defined in config.h have
not been changed.   This will mean that <i>swn</i> will be started as
root, but will almost immediately switch its privileges to those of the
unprivileged user "nobody".  Likewise if <i>wn</i> is running under inetd we
assume that it is set to run with the privileges of "nobody".  

The following list of configurations is in decreasing order of security.

<dl>
       <dt> <b>4.4.1 Forbid CGI and only maintainer trusted</b>
       <dd> This strongest level of security is achieved by
	    running either <i>swn</i> (or <i>wn</i> 
	    under inetd) with the <a href="appendixA.html#t_opt">-t
	    or -T option</a> and with the <a href="appendixA.html#e_opt">
	    -e option</a> and with no other options.  (For the really
	    paranoid uncommenting the <b>#define FORBID_CGI</b> line in the
	    file config.h and recompiling removes the CGI code from the
	    binary.) <p>

	    With these options no CGI programs or filters
	    or script output includes are permitted.  Also the POST
	    method is not accepted (an error is returned for a POST
	    request).  Furthermore only index.cache files owned by
	    the user specified in the -t option are used.
	    The server should be run as "nobody" (the default) and
	    the numeric user id specified with -t should be the maintainer's 

       <dt> <b>4.4.2 Only maintainer or maintainer group trusted</b>
       <dd> This is the the strongest level of security if you need
	    the functionality of CGI scripts or filters or script output
	    as server includes.  This security configuration does not
	    allow any user homepages (unless the maintainer produces the
	    index.cache file for them).  To use this level run
	    <i>swn</i> (or <i>wn</i> under inetd) with the
	    <a href="appendixA.html#t_opt">-t or -T option</a>
	    and no other options.  This places all control in the
	    hands of a single maintainer or a "maintainer group".  No
	    document or script output may be served unless the maintainer
	    has authorized it by explicit mention in one of the index.cache
	    database files.  The server will not recognize any index.cache
	    file unless it is owned by the maintainer specified with
	    the -t option or the group specified with the -T option.  Only
	    one of -t or -T can be used.

       <dt> <b>4.4.3 Restricted user serving privileges</b>
       <dd> This permits users on the server host to have and
	    control their own home pages and documents, but with a number
	    of limitations.  They will not be permitted to run CGI
	    scripts, filters or include scripts.  Also the server will
	    require that every file served (including wrappers and
	    includes) have the same owner as the index.cache file which
	    grants it permission to be served. This means that users can
	    only serve files which they own. <p>

	    This is configuration is obtained by running with the <a
	    href="appendixA.html#e_opt">-E option.</a> and the <a
	    href="appendixA.html#u_opt">-u option.</a> The -E option is
	    similar to the -e option except that index.cache files owned
	    by a trusted user id or trusted group id (set with the -t or
	    -T option) are exempt from the restrictions.  The -u option
	    requires that in order to be served a file must be owned by
	    the owner of the index.cache file which lists it.  Trusted
	    users as specified with -t or -T are exempt from this
	    restriction also.

</dl>

<h3>4.5 Other WN security measures</h3>

One of the security problems encountered with another HTTP server
involved an attack by overflowing an internal buffer with data provided
by the the client in such a way that the (attacking) client could supply
code that the server executed.  I have, to the best of my ability,
defended against this in WN code.  All copying of data supplied by
the client and most copying of data read from the index.cache file
is done by a function which I wrote and which was designed precisely
to deal with this threat.  Excess data which would overflow is discarded
so buffers may contain truncated data, but will not be overwritten.
<p>

Probably the most controversial security "feature" of WN is that it
greatly restricts the set of characters which can be used in file or
path names.  Dangerous characters are not disallowed -- instead only
characters presumed safe are allowed.  The currently allowed
characters are alphanumeric characters and '_', '-', '.', '+','/', and
'%'.  The same restrictions are applied to the PATHINFO part of URL's
for CGI scripts.  This sometimes has caused problems with CGI scripts
that like to include unusual characters in file names or PATHINFO.
Also the server will attempt to resolve all "../" references while
staying in the server data hierarchy.  If these references would
result in a request for a document outside the server data hierarchy
the request is treated like a request containing illegal path
characters.  In particular with "verbose logging" turned on, a message
like "SECURITY Found bad character (%X hex) in path" is logged.  <p>

To defend against a "denial of service" attack the server will refuse
a POST request with post data in excess of 1 megabyte.  This does not
defend against multiple requests with large POST data.  The maximum
allowed size of POST data can be altered by changing the value of
"MAX_POST" in the file wn/wn.c.
<p>


<!-- #WN_end -->
<hr size="4">
<address>
John Franks &lt;john@math.nwu.edu&gt;
</address>
<!-- pnuts --> <a href="index_desc.html">[Previous]</a> <a href="search.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
</body>
</html>








