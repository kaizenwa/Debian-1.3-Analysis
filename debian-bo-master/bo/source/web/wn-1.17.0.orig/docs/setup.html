<html>
<head>
<title>Installation and Setup</title>
</head>
<body>
<!-- pnuts --> <a href="overview.html">[Previous]</a> <a href="index_desc.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
<hr size="4">
<!-- #WN_start -->
<h2 align="center">Installation and Setup</h2>
<hr size="4">

<h3>2.1 <A NAME="installing">Installing the Software</a></h3>

Get the file wn.tar.gz  and uncompress it and untar it to make the WN
source directory hierarchy.  This file is available via anonymous ftp
from ftp.acns.nwu.edu in the directory /pub/wn.  The file must be
uncompressed with the GNU compression utilty gzip (or gunzip).  The
resulting file wn.tar should be unpacked with the Unix command "tar
-xvf wn.tar".  The top level of the directory created by untarring
this file contains several directories, including: wn, wndex, authwn
and docs. <p>

If your system supports perl, the quickest way to get your server
configured is to run the perl script "configure" which is in the main
source directory.  Do this with the command
<blockquote>
     perl configure
</blockquote>

This script will ask you various questions, like what version of
Unix you are using and the path to the directory you want to be
the root of your data hierarchy.
<p>

Default answers are printed in square brackets [ ] so you can
simply press return to enter that value.  You can quit at
any time by pressing Ctrl-C and nothing should be changed.
If you want to try it once to see what the questions are, that
is fine.
<p>

This script creates two files: "config.h" and "Makefile" which
are customized based on the answers you gave.  You may rerun this
script as many times as you like.  The first time you run the
script the default values are those in the file config.h.dist.
Subsequent times the default values are taken from the most
recent config.h you have produced (if it still exists).
<p>

An alternative to running this script is to copy the files
"Makefile.dist" and "config.h.dist" to "Makefile" and "config.h"
respectively and edit them manually.  If you want to use some of the
features which are not turned on by default like multiple IP
interfaces, you will have to edit at least "config.h".  I recommend
starting with the perl script and getting your server up and running.
Then you can go back browse through config.h to see if there are
things you want to change.  If there are you will have to re-compile
but that takes only a few minutes.  <p>

Here are some of the questions you will be asked when you run
"configure."  You will be given a list of supported operating systems
and asked to pick the one you are using, e.g. SUNOS, SOLARIS2, AIX,
LINUX, etc.  You will be asked the complete path name of your data
directory.  You will also have to enter the names of the <a
href="#logging"> access logfile</a> and the error logfile you wish to
use (they can be the same file).  If you don't want logging or you
want to use the system syslog facility (i.e.  the <a
href="appendixA.html#syslog">-S option</a>) then these should both be
defined to be the empty string (i.e. a pair of double quotes with
nothing between them like "" ).  If you specify the names of these log
files then you must make sure that either these two files exist and
are writable by the server or that they are files in a directory where
the server has permission to create them. <p>

Additional customizations in config.h are possible but should not be
needed.  These cusomizations require that you manually edit the config.h
file.  For example, there is a #define DEFAULT_URI line in the
config.h file.  It is set to "/index.hmtl".  This is the document
returned in response to a request with only the hostname, (something
like http://hostname.edu/ with no file name at the end).  You would
need to change it if, for example, you wanted to have the default
server response be to run a <a href="cgi.html">CGI script.</a>  <p>

There is also a #define NO_DNS_HOSTNAMES line in config.h which is
commented out by default.  Uncommenting this line will mean that there
will be no hostnames in your log file, just IP addresses.  This will
reduce the load on your server (but probably not speed up responses
since the lookups usually take place after the transaction is
complete).  Keep in mind that uncommenting this will mean that none of
your CGI scripts will get the hostname and also that your <a
href="access.html#ip">access files</a> cannot have hostnames in them,
just IP addresses.  <p>

You may also customize the file "Makefile" in the top level directory.
In particular you should do this if you wish to specify a C compiler
other than cc (e.g. gcc) should be used for compiling.  Also some
systems require that special libraries for sockets, or whatever, be
mentioned in the compile command.  The configuration script attempts
to do this, but I am working from user reports since I do not have
access to most of the UNIX variations.  If they are incorrect please
let me know.<p>

In the top level directory do a "make" to produce the server
<i>wn</i>, the standalone version <i>swn</i> and the utility "wndex".
This utility is used to produce "index.cache files" for use by the
server (it is described below).  If the "make" proceeds without
problem you should next do a "make install".  This will strip the
binaries and place them in the top level bin directory or whatever
directory you specified when you ran the configure script.  <p>

If you specified a log file name or error log file name when you ran
the configuration script or edited config.h you will need to make sure
that these files exist and that they are writable by the user id under
which the server will run.  The best way to do this is create the files
as root ("touch wn.log"), then change their ownership to the appropriate
user ("chown nobody wn.log") and finally set the permissions appropriately
("chmod 644 wn.log").  An alternative is to create a directory in which
these files will reside and make sure that the user "nobody" has permission to
create files in this directory.  Then the server will create the files
with proper ownership and permissions.
<p>

<h3>2.2 <A NAME="standalone">Running the server as a standalone daemon</a></h3>

You can now either run the server as a standalone daemon, the <I>swn</I>
executable, or run under inetd, the <I>wn</I> executable.  We first 
describe the standalone version.  Run this with the command

<blockquote>
	swn -p port [other options] /path/to/wnroot
</blockquote>
<p>

where "port" is the number of the port on which you wish the server to
run.  If this is a non-privileged port (i.e. &gt; 1024) then
<I>swn</I> can be run as an ordinary user.  However, for privileged
ports like 80 you must run the command above as root.  If swn
is run without the -p option it will use port 80 by default.  If
swn is run by root then when it starts up it will change its
user id to the one set when running the configuration script or by
editing the config.h file line where USERID is #defined.  Otherwise it
will have all the permissions of the user who runs it. <p>

The safest practice is to use the numeric UID of "nobody" for the
USERID set in config.h (this is the default) and then start the server
as root. [Note: on HPUX and perhaps other systems user "nobody" cannot
be used.  In this case just create a new user, say www, with the
fewest possible privileges and no shell.]  The server needs to have
root permissions to connect to a socket on a privileged port and
listen for requests.  But immediately after doing so it will change
its user id to that of "nobody" and have minimal access permissions.
In this situation the user "nobody" needs to have only read permission
to your server data and should not own or have have write permission.
In particular "nobody" should not have ownership or write access of
the <i>index.cache</i> database file described in the <a
href="index_desc.html">data hierarchy chapter</a> of this guide.  <p>

<h3>2.3 <A NAME="inetd">Running the server under inetd</a></h3>

The other way to run the server is to use it under inetd. This is an
efficient way to run the server if the load on it is relatively light
(a few thousand hits per day) and the host on which it runs is used
for other purposes.  There are variations on how inetd works from
system to system so you may need to look at the man page for
inetd.conf(5).  Here's how it works under many systems, e.g. SunOS
4.1.3: Edit the file /etc/services and create the line

<blockquote>
     wn  80/tcp
</blockquote> <p>


(or replace 80 by the port you wish to use).  Then edit the file
/etc/inetd.conf and insert the line

<blockquote>
     wn    stream    tcp nowait    nobody    /full/path/for/wn    wn
</blockquote> <P>

After the last <i>wn</i> you can have optional arguments to turn on
logging or use a different data directory.  Some inetds limit the
number of arguments you may use so I prefer to use a small script in
place of wn here.  My inetd.conf line looks like

<blockquote>
     wn    stream    tcp nowait    nobody    /full/path/for/wnwrap    wnwrap
</blockquote> 

and wnwrap contains only the two lines

<blockquote>
     #!/bin/sh<br>
     exec /full/path/for/wn -t 202 -L /my/log/file /my/WN/root/dir
</blockquote> <P>

It is important to run <i>wn</i> as "nobody" (the fifth field in the
inetd.conf line above) or some other user with no special access
privileges.  If you are using an inetd with without the capability to
set UID on startup (e.g., Ultrix), you should define the group ID and
user ID in config.h so that the program is not running as root (look
for the #defines USERID and GROUPID and set the values appropriately).
It should <B>never</B> be necessary to run <i>wn</i> under inetd as
root and to do so would be a serious mistake for maintaining security.
Every attempt has been made to make <i>wn</i> as secure as possible,
even if it is run as root, however, no program accessible to remote
users on the internet can be assumed perfectly secure. (See the
<a href="security.html">security guide</a>).  <p>

After editing the inetd.conf and services files you should find the
process id number of the inetd process and do the command "kill -HUP
pocess_id#".  This must be done as root.  You find the process_id#
using the UNIX command ps.  If you have never done this
before, get someone who has to help you. <p>



<h3>2.4 <a name="hostname">Your Hostname: What's in a name?</a></h3>

If the fully qualified domain name of your server is abc.com
you might like to have your server known as www.abc.com or some
other "vanity" name.  For most purposes this is simply a matter
of properly setting up domain name service (DNS) on your system
so that the system responds to the desired name.
<p>

<i>Note: To use multiple vanity names for different IP addresses on
a single server see the section on <a href="multi.html">multi-homed servers.
</a></i>
<p>

There are a few instances, however, where the WN server does use its
own hostname.  Ideally, in my opinion, the server should do nothing
with its hostname and not even need to know it.  This is not possible
for two reasons.

First, the CGI protocol requires the server to pass its hostname to CGI
scripts in an environmental variable whenever those scripts are run.
Secondly clients often implement redirection so that it cannot handle
relative URLs but only complete URLs.  (This is a mistake in my view,
but one we have to live with.)  Thus when a server redirects to
another local document it must supply its own hostname.
These are the only places WN uses hostname.
<p>

For most cases then, WN only uses it hostname when a redirection is done.
This happens in several circumstances.  The most common is when a request
is made for a directory any the trailing '/' is left off of the URL.
<p>

So how does WN know its hostname?  When you run the "configure"
program you are queried for the value you want or you have the option
of using a system call at the time the server is run.  This value is
placed into the config.h header file and compiled into your server.
In the file config.h the WN_HOSTNAME value is set by default to the
empty string.  If this is not changed the server will get its name
from the gethostaddr() system call.  If this is set to another string
that string will be used.  If you are using WN as a multi-homed server
then you need to set different names for the different IP addresses.
This is done in the file wn/vhost.h which you edit to set up the
correspondence between IP addresses and root directories.  <p>

<h3>2.5 <a name="testing">Testing Your Setup</a></h3>

After compiling and setting up the software you can test it on a sample
directory provided with the distribution.  To do this first make a 
symbolic link in your root data directory to the "docs" directory 
in the source distribution.  The command "ln -s /your/src/dir/docs docs"
executed in the root directory should do this.  If your system does not
support symbolic links you can copy this directory and its subdirectories
to your data directory temporarily.  <P>

Now you are ready to test your server installation on this directory.
Try it with your favorite HTTP client. The URL should be
<blockquote>
     http://YourHost/docs/index.html
</blockquote>
<p>

<h3>2.6 <a name="shutdown">Shutting Down Your Server</a></h3>

If your are running under inetd as described above then to shut down
the server first remove or comment out the line you created in the
file inetd.conf.  Then you should again find the
process id number of the inetd process and do the command "kill -HUP
pocess_id#" just as you did to start <i>WN.</i> <p>

If you are running swn, the standalone version of WN you will
have to use the UNIX ps command to find the process id of the running
swn daemon.  Then as root you run the command "kill -9 process_id#"
where, of course "process_id#" is the process id of swn. <p>


<h3>2.7 <a name="logging">Managing Logfiles</a></h3>

There are two ways to log WN transactions -- using dedicated
log files or using the standard UNIX syslog facility.  We first
describe dedicated log files.
Normally when you use WN you will keep two logfiles.  The first is
a log of all "normal" transactions and the second records error
conditions or items which might require your attention.  For example,
if the server cannot find a file which your index file indicates
should be served it will log an error.  There are two ways to
tell the server the names of these files.  The first is by supplying
the file names  when you run the configure script and then compiling
these into your server.  And the second is by supplying the file names
on the command line when you execute the server.
<p>

For example, executing the command
<blockquote>
     swn -L /path2/logfile -l /path2/error.log &nbsp; /path/wnroot
</blockquote>

will cause the server to use "logfile" and "error.log" as the
logfile and error log respectively.  Of course, it is necessary for
the server to have write permission to these files and execute permission
on the directory containing them.
<p>

A good way to achieve this if the server is running as "nobody" is to
create the files yourself and change their ownership to the user
"nobody."  This can be done, for example, with the commands

<blockquote>
     touch logfile<br>
     /usr/etc/chown &nbsp; nobody &nbsp; logfile<br>
     chmod 600 &nbsp; logfile<br>
</blockquote>

executed as root in the directory where the logfile is to reside.  The first
of these commands creates the file "logfile".  The second makes "nobody"
the owner and the third gives "nobody" (and no one else except root) permission
to read and write this file.  You might want to allow others to read, but
not write to the logfile, or security of the logfile might not be a concern.
<p>

Thus a script executed by cron to rotate logfiles might look like

<blockquote>
     cd /logfile/dir<br>
     mv logfile &nbsp; logfile.old<br>
     touch &nbsp; logfile<br>
     /usr/etc/chown &nbsp; nobody &nbsp; logfile<br>
     chmod 600 &nbsp; logfile<br>
     kill -HUP `/bin/cat &nbsp; wn.pid`<br>
     /usr/etc/chown &nbsp; maintainer &nbsp; logfile.old<br>
     chmod 600 &nbsp; logfile.old<br>
</blockquote>

where wn.pid is a file containing the processs id of the server
created by using the <a href="appendixA.html#q_opt">-q option</a>
or by specifying this filename when the "configure" script is run.
If neither of these has been done the standalone server, swn,
will print its process id on standard output when it is run.
If you are using wn under inetd there is no need to send the -HUP
signal as the server must close this file after each transaction.<p>

There are two modes which the server can use in writing its logfiles:
verbose and "common log format".  The verbose mode is essentially the
common log format but with the user-agent, referrer, and HTTP cookie
of a transaction appended to the line for that transaction as well as
better transaction error messages if necessary.  The mode is chosen
by answering the relevant question when running the configure script
before compilation (or by editing config.h).
<p>

When the server is invoked with <a href="appendixA.html#v_opt">the -v
option</a> it will write a log file in the format specified by the
value of this option.  The legal values for this option are "common",
"verbose", and "ncsa".  They cause the logfile to be written in the
so-called common log format, or WN's verbose format including user
agent, referrer and cookies, or in the NCSA extended format which
includes referrer and user agent.  If this option is not specified the
server will default to either the common log format or the WN verbose
format depending on which was selected when the "configure" script was
run.
<p>

The utility <a href="utility.html#v2c">V2C</a> can convert verbose
log files to log files in the shorter common log format.
<p>

<h3>2.8 <a name="trouble">Trouble Shooting</a></h3>

If things are not working as they should here are some tips to help
you isolate the problems. <P>


If the compilation was successful you can check the server itself by
executing it from the command line.  If you use the command

<blockquote>
     wn  /full/path/of/root/dir
</blockquote>

it should run and pause for input.  Type the line

<blockquote>
     GET &nbsp;/&lt;ret&gt;
</blockquote>

and in response wn should print the raw HTML of the index.html file in
your top level directory (perhaps along with a message about not being
able to open a log file).  If instead you type

<blockquote>
     GET &nbsp;/docs/overview.html&lt;ret&gt;
</blockquote>

(and you still have the /docs subdirectory in your top level
directory) the overview document should be sent to your screen.
If this doesn't happen there should be an error message which may be
helpful.  Better error messages are placed in the log file so you may
want run wn again with the additional arguments "-L logfile" and then
examine the contents of the logfile.  Or if you run "wn -L /dev/tty"
the log entries will be printed to your screen instead of being put in
a file. If the server can't open a file, for example, the name of that file
will be recorded in the logfile. Check its permissions. Remember that
all files that wn serves must be world readable.  More serious errors
are put in a separate error log.  So you might want to try the command
"wn -L file -l file2"  and then type the GET requests described above.
<p>

If this succeeds you should should run the server for real, either
under inetd (as described above) or standalone (with an swn command).
In order to use port 80 the server must be started by root.  It will
then switch to user "nobody".  It does this immediately after
connecting to port 80, before it does anything else including openning
its log file.  If you get a message that the server cannot open its
log file then either you have specified putting the log file in a
directory where user "nobody" does not have permission to create files
or you have specified an existing file which the server does not have
permission to write.

After starting the server a useful test is to telnet to your server at
port on which you are running.  You should get a connection message
and a pause for input.  If you get a "Connection refused" message and
you are running under inetd, it is likely there is a problem with your
inetd setup or for some reason your system can't find or can't execute
the wn binary.  If you are using swn this message means that swn is
not in fact running. <p>

If you still have problems feel free to ask questions on the WN listserver.
There are many helpful people there.  But it is a good idea to try the
steps above first and to include the relevant logfile messages with your
request. <p>


<!-- #WN_end -->
<hr>
<address>
John Franks &lt;john@math.nwu.edu&gt;
</address>
<!-- pnuts --> <a href="overview.html">[Previous]</a> <a href="index_desc.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
</body>
</html>
