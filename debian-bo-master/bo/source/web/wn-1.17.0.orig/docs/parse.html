<html>
<head>
<title>Parsed Text and Server Side Includes</title>
</head>
<body>
<!-- pnuts --> <a href="search.html">[Previous]</a> <a href="field.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
<hr size="4">
<!-- #start -->
<h2 align="center">Parsed Text and Server Side Includes</h2>
<hr size="4">
<p>
The WN server has powerful capabilities for modifying a text
file as it is served.  One such feature, called "server-side
includes", is the ability to automatically insert one file in
another.  But the usefulness of this capability is greatly
enhanced by another feature, <a href="#if">conditional text.</a>
A simple if - else - endif construct allows sections of a document to
be served only to certain hosts, or to clients providing an
appropriate Accept header or a desired Referer or User-Agent header.
Using the "else" construct allows alternate text segments for clients
not meeting the desired criteria.  For these features to work it
is necessary for the server to parse the file looking for the location
of includes or for conditionally served text.  The fact that a file
should be parsed in this way is indicated in its entry in its
index file.  This is done with an entry "Attributes=parse" in the
file record. See the <a href="appendixB.html#attributes">section concerning
attributes</a> in Appendix B.  (This line is not neccessary if the
file record lists wrappers or includes since it is assumed in
that case.)
<p>

<h3>6.1 Wrappers and Includes</h3>

The simplest and most common use of parsed text is including
additional files in one which is being served or "wrapping" a served
file with a second file, i.e. inserting the requested file inside the
second at a desired location.  This latter is useful, for example, if
you wish to place a standard message at the beginning or end (or both)
of a large collection of files.  All files included or used as
wrappers must be listed in the index.cache file.  They are not listed
in the file in which they are to be included; only the location of the
insertion is marked. <p>

To ensure security various options are available including the the
requirement that a served file and all its includes and wrappers have
the same owner as the index.cache file listing them.  This is done
with the <a href="appendixA.html#u_opt"> -u option</a>.  <p>

Another important application of wrappers is to customize the HTML
documents returned listing the successful search matches.  If, for
example, a directory is assigned a wrapper the server assumes that it
contains all text describing the search and it merely supplies an
unordered list of links to the matching items.

<h3>6.2 Simple Including</h3>

Suppose your server offers the file <i>foo.txt</i> and you wish to
have the file <i>bar.txt</i> automatically inserted at some point.
You achieve this by use of the "Includes=" directive in the index
file in the directory containing foo.txt.  That index file should
have an entry like

<blockquote>
     File=foo.txt<br>
     Includes=bar.txt<br>
</blockquote>
<p>
and the file foo.txt should contain either of the lines
<blockquote>
     &lt;!-- #include --&gt;<br>
     or<br>
     &lt;?WN #include &gt;<br>
</blockquote><p>

These two forms are equivalent as far as the server is concerned.
The second form is considered more SGML friendly by many as &lt;?WN
something &gt; indicates a processing instruction specific to WN
rather than a comment.  For historical reasons this manual describes
the other form, but either may be used.  With the first form the '#'
is required but with the other you may use either

     <blockquote>
     &lt;?WN #include &gt;
     or<br>
     &lt;?WN include &gt;<br>
     </blockquote>
<p>

Any of the "&lt;!-- #something --&gt;" lines described in this
section may be replaced using the "&lt;?WN" syntax.  Also with
this syntax the case of the WN is not significant.
<p>


The marker &lt;!-- #include --&gt; should be the only thing on its line
but may have white space before it.  It is fine to use the
line &lt;!-- #include bar.txt --&gt;, but the bar.txt is only a comment
and has no effect on which file is actually inserted.  This is controlled
by the Includes= line in the index file.  All including of files
by WN is done only for text files and only in units of lines.<p>

If the include marker is never found in foo.txt, then this file is served
and the file bar.txt, is appended at the end.  Thus the Includes=
directive can be used to append a file without the need of any
marker in the main file.<p>

If you wanted to include two files in foo.txt, say bar.txt and bah.txt
you would place the marker &lt;!-- #include --&gt; at two places in
foo.txt and have an entry in your index file like
<blockquote>
     File=foo.txt<br>
     Includes=bar.txt,bah.txt<br>
</blockquote><p>

The two files will then be included at the marked spots in the order
that they are listed in the Includes= directive, i.e. bar.txt will
be inserted at the first marker and bah.txt at the second.  You can
have as many included files as you wish.  They should all be listed
on the "Includes=" line separated by commas. <p>

Instead of a file it is possible to include the output of a program
or script.  To do this the program is listed in the Includes= directive
but its name is preceded with the '!' character. For example
<blockquote>
     File=foo.txt
     Includes=!/usr/bin/date -u,bar.txt
</blockquote>

will insert the time and date (GMT) at the first
&lt;!-- #include --&gt and the contents of bar.txt at
the second.  This ability to serve the output of programs can be
restricted in several ways.  If <i>WN</i> is invoked with the
<a href="appendixA.html#e_opt">-e option</a> then no includes, filters,
or CGI programs will be executed.  <p>


The -E option in conjunction with the
<a href="appendixA.html#t_opt">-t or -T options</a> restricts 
the execution of programs to those listed in index.cache files
owned by trusted users or groups.  The <a href="appendixA.html#u_opt">
-u option</a> allows the execution of programs or inclusion of files
owned by the owner of the index.cache file which lists them.  If the
-E and -u option are used together the -E takes precedence. <p>

If you wish to have all the standard CGI environment variables made
available to the executed include program you can do so by adding the line
<blockquote>
     <a href="appendixB.html#attributes">Attributes</a>=CGI
</blockquote>
to the file record.  A list of these environment variables can be
found in the <a href="appendixD.html">Appendix D.</a>
(Also see the <a href="examples/sample.cgi">sample CGI script</a>
which is located in the file /docs/examples/sample.cgi which accompainies
the WN distribution.)
<p>


<h3>6.3 <a name="if">Conditional text: If, Else, and Endif</h3>

Often a server maintainer may wish to serve different versions of
a document to different clients.  Here is a simple example of how
this can be handled with WN.

<blockquote>
&lt;!-- #if accept =~ "image/jpeg" --&gt;<br>
<br>
     &lt;a href="picture.jpg"&gt;<br>
     Here is the jpeg version of the picture:<br>
     &lt;/a&gt;<br>
<br>
&lt;!-- #else --&gt;<br>
<br>
     &lt;a href="picture.gif"&gt;<br>
     Here is the gif version of the picture:<br>
     &lt;/a&gt;<br>
<br>
&lt;!-- #endif --&gt;<br>
</blockquote>

This tells the server to look at the Accept: headers provided by the
client and if "image/jpeg" is among them then use the jpeg image and
otherwise use the gif image.  More precisely, the "image/jpeg" part of
the "if" line is a grep-like regular expression and if there is any
match for it among the Accept headers the jpeg image will be used.  Of
course these if - else - endif constructs can be nested.  A similar
construct allows you to make the text served depend on matching a regular
expression with the contents of the User-Agent header, the Referer
header, the Cookie header, the client hostname, or the client IP
address.  A complete list of possible test clauses for the #if
statement is contained in <a href="appendixC.html">Appendix C.</a><br>
<p>

<b>Important:</b> For this to work the file containing the conditional
text needs to be parsed by the server.  The server only knows to do
this if the file record in the index file contains a line "Attributes=parse".
See the <a href="appendixB.html#attributes">section concerning
attributes</a> in Appendix B for full details.
<p>

If, in an "if clause", instead of the equal-tilde string =~ (to indicate
a regular expression match) the character string !~ is used then the
truth value of the match is reversed.  For example the lines
<blockquote>
&lt;!-- #if referer !~ "my.host.edu" --&gt;<br>
     Here is some text for newcomers to my site.<br>
&lt;!-- #endif --&gt;<br>
</blockquote>
would display the "newcomers text" to those clients accessing this
document via any link which is not on the host my.host.edu.
<p>

There is also a <a href="appendixC.html#redirect">redirect command</a>
which can conditionally cause the server to send an HTTP redirect to
a new URL.  For example if the text

<blockquote>
&lt;!-- #if hostname =~ "\.uk$" --&gt;<br>
&lt;!--      #redirect = "UK_mirror_url" --&gt;<br>
&lt;!-- #endif --&gt;<br>
</blockquote>

is included at the beginning of an HTML document then any request from
a UK host will automatically be redirected to the specified URL, the
UK_mirror_url in this case.  This mechanism could also be used to
redirect text only browsers to a text only alternative page, etc.
There must be no text sent before the &lt;!-- #redirect = "url" --&gt;
is entcountered (not even blank lines) since the server cannot send an
HTTP redirect while in the middle of tranmitting a document.
<p>

Normally the URL in the &lt;!-- #redirect = "URL" --&gt; line is
fully qualified, like "http://host/path/foo".  However, it can also
be simply "foo" referring to a file in the same directory as the
file being parsed.  In this case an HTTP redirection is not sent, and
instead the file "foo" is returned immediately to the client.
<p>

Often a single regular expression is not adequate to distinguish
whether or not to serve some text.  For that reason WN allows you
to use a file containing any number of regular expressions and
serve a document based on whether any of these expressions match
accept headers, referer header, user-agent, hostname, etc.

For example, if the file "acceptfile" contains the lines
<blockquote>
     image/gif<br>
     image/jpeg<br>
     image/x-xbitmap<br>
</blockquote>
then the following conditional text might be appropriate:

<blockquote>
&lt;!-- #if accept file = "acceptfile" --&gt;<br>
<br>
     I see you aren't using a text only browser...<br>

&lt;!-- #endif --&gt;<br>
</blockquote>
<p>

The format of the file "acceptfile" is one grep like regular
expression per line.  Lines beginning with '#' are taken to be
comments.  If a regular expression is preceded by the character
'!' then that character is skipped but the truth value of the
match is reversed.
More information about files of regular expressions for conditional
text can be found in <a href="appendixC.html">Appendix C.</a>

<h3>6.4 Conditional Text and Access Control Files</h3>

Another method of using conditional text is with a normal WN access
control file.  For example

<blockquote>
&lt;!-- #if accessfile="secret/access" --&gt;<br>
<br>
     Here is a link to a restricted directory.

     &lt;a href="/secret/stuff.html"&gt;Restricted Local Stuff&lt;/a&gt;<br>

     Hosts not listed in the file "secret/access" can't look
     at it, so why show them a link to it?<br>
<br>
&lt;!-- #endif --&gt;<br>
</blockquote>

will display the included text and the link to "Restricted Local Stuff"
only to clients on hosts permitted by the <a href="access.html">
access control file</a> "secret/access."
<p>

<h3>6.5 <a name="section">More on Including: the "section" marker</a></h3>

Often you may want to include HTML files in a larger document.  For
example, a single logical HTML document often consists of a number of 
separate files.  This can make it very difficult for a client to
download and print the entire document.  To alleviate this problem
you could form a single document concatenating all the pieces, but
that can be problematic when the document is altered or updated as
it is necessary to change both the piece and the concatenation.

WN offers a solution to this by allowing you to write a small
skeleton document which includes all the pieces, forming a "virtual"
document which is the concatenation.  But if we just used
the mechanism above the concatenation document would include
the &lt;head&gt; elements of all the pieces.  To remedy this you use the
marker 
<blockquote>
     &lt;!-- #section --&gt;
</blockquote>
<p>

instead of &lt;!-- #include --&gt; and the server will include only the
portion of the HTML document between the special comments
&lt;!-- #start --&gt; and  &lt;!-- #end --&gt; inserted in
that document.  This requires that these starting and ending comments
occur in the HTML document on lines by themselves and with no
preceeding white space. <p>

<h3>6.6 Wrapping Files</h3>

Suppose you have a large number of files and want a standard header or
footer placed on all of them (perhaps a standard disclaimer).  You could,
of course, make many copies of the standard header with a different
Includes= directive for each, but this is cumbersome.  It has other
drawbacks as well, such as the fact that grep and context
<a href="search.html">searches</a> do not search associated include
files, only the main file.  <p>

To deal with this case <i>WN</i> uses <i>wrappers.</i> Wrapping a file
is the inverse of including it.  If you have an index file
entry like
<blockquote>
     File=foo.txt<br>
     Wrappers=bar.txt<br>
</blockquote>
<p>
then the server will send the file bar.txt looking for the marker
&lt;!-- #include --&gt; and inserting foo.txt at the line where it
is found.  So this is just like the Includes= directive except the
role of which file is included in the other is reversed.
If the include marker is never found the entire wrapper, bar.txt, is sent first
and the main file, foo.txt, is appended at the end.  Thus the Wrappers=
directive can be used to prepend a file without the need of any
marker in the main file. <p>

<h3>6.7 Search Wrappers</h3>

A search wrapper is a special kind of wrapper.  Its function is to allow
you to customize the results of user searches.  It is normally associated
with an entire directory in which case it applies to all title, keyword, field,
grep and context searches  of that directory (see the <a href="search.html">
chapter on searching.</a>) <p>

A line like
<blockquote>
     SearchWrapper=foo.html
</blockquote>
in the directory record of an index file will cause any search of that
directory to return an unordered list of matches wrapped with the file
foo.html.  The list of matches will be inserted into foo.html at a point
where the marker &lt;!-- #include --&gt; is found.  You can also insert
the user supplied search term by using the marker &lt;!-- #query --&gt;.
Both of these markers must occur on a line by themselves with no leading
white space. <p>

<h3>6.8 Nested Including and Wrapping</h3>

Wrapping and including can be arbitrarily nested (though this is not
true of Search Wrappers).  It can be a little complicated to get
the effect you want.  <p>

Here is how to do it.  Think of all your files,
wrappers, includes and the main file arranged as you wish them to be combined
for the final served document.  Now imagine inserting an opening (or left)
parenthesis at the beginning of each file and insert a closing (or right)
parenthesis at the end of each file.  You should have a legally nested
and balanced collection of parentheses.   To each of the opening parentheses
attach the name of the file which begins at that point.  Then write down
the list of all the file names in the order their corresponding opening
parentheses occur.  All the files which come before the main file should
be wrappers and should be listed in the Wrappers= line in the order in
which they occur in this list.  All the files after the main file should
be in the Includes= line and should occur in the order they occur in this
list.
<p>

Here's a simple example.  Suppose we have a main file M and other files
A,B,C, and D which we want to have nested like
<blockquote>
     (D...(B...B)...(M...(A...(C...C)...A)...M)...D)
</blockquote><p>

Then the entry in the index file should look like
<blockquote>
     File=M<br>
     Wrappers=D,B<br>
     Includes=A,C<br>
</blockquote><p>

<h3>6.9 <a name="title">Including Title, Query, Fields and Environment
Variables</a></h3>

Often it is useful to insert items like the main document's title into a
wrapper, or the search item provided by the client into a searchwrapper
for the responses.  This is possible with WN parsed documents using the lines

<blockquote>
     &lt;!-- #title --&gt; <br>
     or<br>
     &lt;!-- #query --&gt; <br>

</blockquote>

in the file at the point where the title or search term should be
inserted. Both of these markers must occur on a line by themselves
with no leading white space.
<p>


In addition to the title and query <a href="field.html">user supplied
fields</a> can be inserted
in documents.  This is done by including a marker such as
&lt;!-- #field3 --&gt; in the file at the point where the value should
be inserted.  This should occur on a line by itself with no whitespace
before it.

You can also insert the value of any environment variable into your
text with a line like

<blockquote>
     &lt;!-- #environ = "HTTP_REFERER" --&gt; <br>
</blockquote>

which will be replaced by the contents of the environment variable
HTTP_REFERER.
<p>

<em>Important Note:</em> If there is no Wrappers= or Includes= line in
the index file for this entry then there must be a line like

<blockquote>
     Attributes=parse
</blockquote>

so the server knows it is to parse the file to look for the marker.
See the <a href="appendixB.html#attributes">section concerning
attributes</a> in Appendix B for more details.  Also if you wish to
insert the value of a CGI environment variable (as in the example
above) you must have an "Attributes=parse" line.

<!-- #end -->
<hr size="4">
<address>
John Franks &lt;john@math.nwu.edu&gt;
</address>
<!-- pnuts --> <a href="search.html">[Previous]</a> <a href="field.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
</body>
</html>


