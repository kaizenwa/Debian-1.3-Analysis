<html>
<head>
<title>Creating your data hierarchy</title>
</head>
<body>
<!-- pnuts --> <a href="setup.html">[Previous]</a> <a href="security.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
<hr size="4">
<!-- #WN_start -->
<h2 align="center">Creating your data hierarchy</h2>
<hr size="4">

<h3>3.1 <a name="index">The <i>Index</i> file</a></h3>


In each directory of your data hierarchy you create a file called
<i>index</i> with information about each file you want to serve.
This simplest index file might contain the single line
<p>

<blockquote>
     Attribute=serveall
</blockquote> <p>

which when properly processed will grant the server permission to
serve any file in the directory (but not in subdirectories).  For
more information about this directive see the setcion on the
<a href="#serveall">serveall attribute</a> below.
A more elaborate index file might look like the following: <p>

<blockquote>
     Owner=mailto:webmistress@host.edu<br>
<br>
     File=file.txt<br>
     Title=This is a descriptive title for file.txt<br> 
<br>
     # This is a comment<br>
     File=file2.html<br>
<br>
     File=soundfile<br>
     Title=This plays some sounds<br>
     Content-type=audio/basic<br>
</blockquote> <p>


The file contains four groups of lines called records.  The first
record (the single line starting Owner= in this example) describes
properties of the directory and is called the 
<a href="appendixB.html#dirdirective">directory record</a>.  It can be
empty, but in general it is a good idea for the directory record to
contain an owner line, like the one above, referring to the maintainer
of the directory.  <p>

The remainder of this <i>index</i> file has three 
<a href="appendixB.html#filedirective">file directives</a>
describing three files, <i>file.txt, file2.html,</i> and
<i>soundfile</i>, in the directory which we wish to serve. The line
starting with # is a comment.  Wherever a # occurs the remainder of
that line is treated as a comment (i.e. ignored).
<p>

The index file is processed with the utility <i>wndex</i> (pronounced
"windex") to produce a small database called <i>index.cache</i>
containing information about this directory and its contents.  Detailed
information on the <a href="#wndex"> wndex utility</a> is given below,
but simply running it with no arguments in a directory containing an
<i>index</i> file will produce the <i>index.cache</i> file for that
directory.  This file contains all the information in the index file
plus additional information gathered automatically about the files to
be served.  In particular the index.cache file will list the names of
the files given in the File= lines of the index file.  Any file on the
server whose name is not listed in an <i>index.cache</i> file will not
be served.  This is the basis of <i>WN</i> security.  For security
reasons the server will refuse to use any <i>index.cache</i> file
which is in reality a symbolic link to another file.<p>

The index.cache database has a number of other functions beyond its
security role.  Attributes of the files listed in the index file which
can be computed before they are served and which don't often change
are stored in the index.cache file.  For example, the MIME content
type of <i>soundfile</i> is read from the Content-type= line.  The
other files do not need such a line since <i>wndex</i> can deduce
from the file name extensions that <i>file.txt</i> has type text/plain
and <i>file2.html</i> has type text/html.  This is done once at the
time index.cache is created and need not be done every time the file
is served.  By the way, if the sound file were named <i>soundfile.au</i>
it wouldn't need a Content-type line either.<p>

The title of a file is another example of information stored in the
index.cache file.  With the <i>WN</i> server every file served has a
title (even binaries) and optionally has a list of keywords associated
with it.  For an HTML document the title and the keywords are
automatically extracted by wndex from the header of the document and
stored in fields of that file's line in index.cache.  These are used
for the built-in keyword an title <a href="search.html">searches</a>
which the server supports.  <p>

<h3>3.2 <a name="file_owner">File Ownership and Permissions</a></h3>

The files which you wish to serve should be owned by you, or by
their creator, or by whoever is in charge of maintaining them.
They should not be owned by "nobody" or whatever user id the server
runs under (as set in config.h).  This because the "nobody" id
should have the minimum permissions possible.  It needs to have
read access to the files to be served, but it has no need to be able
to write to those files or alter them in any way.  <p>

Thus normally the files served might be owned by the maintainer
and have their permissions set to be world readable but writable
only by the maintainer (or by no one). <p>

Likewise the index.cache file which controls access to everything in a
directory should be owned by the maintainer of that directory and the
only permission "nobody" should have for this file is read permission.
In fact, for security reasons it the server was started as root 
(and then switched to a safer user like "nobody") wn or swn
 will refuse to use any index.cache file which is owned by the user id
(e.g. nobody) under which the server is running.  This restriction
does not apply if swn is run on an unpriviledged port by an ordinary
user, because such a user might not be able to make index.cache files
owned by someone else.
<p>

There is one exception to the rule of having nothing owned by
"nobody" (and that's not a double negative).  The exception is
the logfiles.  These files must be writable by the server and it
generally seems sensible to have them owned by the user "nobody"
under whose identity the server runs. The log file and the error
log file can be specified on the command line when the server is
run or can be #defined in config.h. <p>

<h3>3.3 <a name="wndex">Using the WNdex utility</a></h3>

Before describing the <i>index</i> file in greater detail we briefly
explain the use of the program which reads this file and produces the
<i>index.cache</i> database file.  Simply running <i>wndex</i>
with no arguments in a directory containing a file named <i>index</i>
causes that file to be read and a file called <i>index.cache</i> to be
created in that directory.
<p>

There are several command line arguments for wndex.  The -r
option causes wndex to recursively descend your data hierarchy
using all subdirectories listed in the Subdirs= line of the
directory record in the index file (<a href="#dir_record">see
below</a>).
<p>

The -i and -c options specify an alternate name for the index file
and the index.cache file respectively.  For example the command
<tt>wndex -i foo -c bar</tt> will attempt to use <i>foo</i> as the
index file and produce the file <i>bar</i> instead of <i>index.cache.</i>
<p>

The -d option specifies a directory other than the current directory
in which to find the <i>index</i> file and in which to create the
<i>index.cache</i> and <i>index.html</i> files.
<p>

Finally the -q option (for quiet) supresses the printing of any warning
or informational messages by <i>wndex.</i>
<p>

<h3>3.4 <a name="dir_record">The Directory Record</a></h3>

The first group of lines in an index file provides information about
the directory itself and the collection of files it contains rather
than about any single file in the directory.  It is called
the directory record. This beginning collection of lines might look like

<blockquote>
     Owner=mailto:you@host.edu<br>
     SearchWrapper=dir_search_wrap<br>
     Accessfile=/dir/access<br>
     Subdirs=dir1,dir2,directory3<br>
</blockquote>
<p>

This specifies the owner of items in the directory (which is used in
the HTTP headers sent by the server).  It also specifies a "wrapper"
for the various searches of the directory, that is an HTML document
which provides a customized response listing the matching items
in one of the various searches of the directory (for more details
see the section on <a href="parse.html">server-side wrappers and includes.</a>)
The Accessfile= line specifies the name of the file which controls access
(by IP address) to this directory.  If this item is omitted then
items in the directory may be served to anyone.  For more information
on using the access mechanism see the section of this document on
<a href="access.html">access.</a>  Finally the line starting with
Subdirs= specifies the subdirectories of this directory which you
wish to have recursively searched when a title or keyword search
is done on this directory.  More information about searching can
be found in the <a href="search.html">chapter on searches,</a><p>

After the directory record line group an index file will typically
have groups of lines called file records describing a particular
file.  A file record can be as simple as a single line like the
line "File=file2.html" in the example above or it can contain several
lines describing the file.  For a complete list of the possible
lines (called "directives") which a file can have see
<a href="appendixB.html">Appendix B.</a>

<h3>3.5 <a name="default">Your Default Page</a></h3>
When someone sends a request to your server with only the server
name and no file name like
<blockquote>
     http://hopf.math.nwu.edu/
</blockquote>
the <i>WN</i> server automatically translates this to 
<blockquote>
     http://hopf.math.nwu.edu/index.html
</blockquote>

adding the file name "index.html".  More generally if a request is
made for a directory, say with the URL <i>http://host/dir1/dir2/</i>,
this will be translated to a request for
<i>http://host/dir1/dir2/index.html.</i>
<p>

If you wish the default file name in a particular directory to be
something other than "index.html" you can use the <a
href="appendixB.html#defdoc">Default-Document=</a> directive in the
directory record of your index file to change it.  If you wish to change
the default file name for all directories on the server you can change
the #define INDEXFILE_NAME line in the config.h file and recompile.
<p>


<h3>3.6 <a name="serveall">Serving files not listed in an Index file</a></h3>

WN is also able to serve files without explicitly listing them in an
index or index.cache file.  This is done by putting the line

<blockquote>
     Attributes=serveall
</blockquote>

in the directory record of the index file for a directory.  It
specifies that any file in this directory, which does not start with
the character '.', or end with '~', may be served, not just those
listed in the <i>index</i> file.  The files "index" and
"index.cache" will also not be served.  The server will attempt to set
the content type correctly based on the file name suffix using the
same default correspondences between type and suffix that
<i>wndex</i> uses.  If the "Attributes=serveall" line (and the
corresponding entry it creates in the index.cache file) are not
present then only the files explicitly listed will be served.
 <p>

It is fine to have file records in an index file which also has the
"Attributes=serveall" directive.  In this case the file directives
take precedence.  Thus if you had an index file consisting of

<blockquote>
     Attributes=serveall<br>
<br>
     File=foo.html<br>
     Content-type=application/postscript<br>
</blockquote>
the server would consult the file record for foo.html first and
see that it is of type application/postscript (it would be silly
to actually do this, of course) and use that type.  But another
file "bar.html" in the directory would also be served with the
type indicated by its suffix.  Files with no file record in the
index file and no recognized suffix will be given the default
content type which can set with the <a href="appendixB.html#defcon">
Default-content directive.</a>
<p>

When wndex is run on an index file with the serveall attribute
all the files currently in that directory which can be served are
given entries in the index.cache file.  Title and keyword searches only
see files listed in an index.cache file. Likewise context and grep
searches only seek matches in files listed in the index.cache file.
Thus if a file is added to a directory with the serveall attribute
it will not be visible to searches unless wndex is re-run in that
directory.  If it has not been re-run the file will still be served,
however.  Still, it is good practice to re-run wndex every time you
add or delete a file in a directory with the serveall attribute.
(Of course, it is required to do this for a directory without the
serveall directive.)  There is no need to re-run wndex if you only
change an existing file, unless you change its title or keywords.
<p>

There is no way to use wrappers or includes for files not listed in
the index file.  So generally, the few seconds it takes to add
a document's name and a descriptive title to your index file and then
to run wndex will pay off.
<p>

If you do not wish the "Attributes=serveall" directive to be allowed
on your server you can disable it by uncommenting the "#define
NO_SERVEALL" line in the config.h file.  This does not affect the
ability of wndex to write index.cache entries for all files in a
directory with the servall attribute.  But it means the server will
only serve files listed an index.cache file.  <p>

<h3>3.7 Customized error messages</h3>

There are three situations when the client request will be denied but
for which you can supply customized error messages. These are requests
for non-existent files, requests for files which require a password
but for which no valid password was given, and requests from an
invalid host for files limited to certain hosts.

The lines

<blockquote>
     <a href="appendixB.html#nosuch">No-Such-File-URL</a>=http://host/dir/nosuch.html<br>
     <a href="appendixB.html#accessdenied">Access-denied-URL</a>=http://host/dir/noaccess.html<br>
     <a href="appendixB.html#authdenied">Auth-denied-file</a>=~/dir/nopassword.html
</blockquote><p>

in a <a href="appendixB.html#dirdirective">directory record</a> of an
index file specify URL's to which clients are redirected when a
non-existent file is requested and when a document protected by an <a
href="access.html#ip">access control file</a> is requested from an
invalid host.  The last line specifies a file to be sent when a
password protected file is requested without a password or with
an invalid password.  For technical reasons it wouldn't work to
have this be a redirection.  

In the first two lines above (specifying redirection) the URL's
given can be relative URL's, so the lines

<blockquote>
     No-Such-File-URL=/dir/nosuch.html<br>
     Access-denied-URL=noaccess.html
</blockquote>

are valid.  Default values for these three directives may be specified
by editing the config.h file and recompiling the server.  More
information on customized error messages can be found in <a
href="appendixB.html#dirdirective">Appendix B.</a>

<!-- #WN_end -->
<hr size="4">
<address>
John Franks &lt;john@math.nwu.edu&gt;
</address>
<!-- pnuts --> <a href="setup.html">[Previous]</a> <a href="security.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
</body>
</html>


