<html>
<head>
<title>Multi-homed or Virtual Servers</title>
</head>
<body>
<!-- pnuts --> <a href="tilde.html">[Previous]</a> <a href="utility.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
<hr size="4">
<!-- #WN_start -->
<h2 align="center"><a name="multi">Hierarchies Based on IP Address --
a Multi-Homed or Virtual Server</a></h2>
<hr size="4">

Many systems allow multiple IP addresses for a single host.  For
systems with this capability it is possible to use a different data
hierarchy for each IP address to which your host responds.  Sometimes
this is referred to as "virtual hosts" or a "multi-homed" server since
when combined with DNS aliasing it permits a single server to appear
to be multiple servers on different hosts. Unfortunately, I cannot
help you in configuring your system to respond to multiple IP
addresses.  (Some information about this can be found at <a
href="http://www.thesphere.com/%7Edlp/TwoServers/">
http://www.thesphere.com/%7Edlp/TwoServers/</a>) However, if your
system supports this capability you can have different data
hierarchies for each IP address if you run the standalone version of
the server (swn).  <p>

<h3>One Server per Virtual Host</h3>

There are two ways to have multiple virtual hosts.  The easiest is to
run multiple instances of the server each with a different hostname
indicated on the command line via the <a
href="appendixA.html#h_opt">-h hostname</a> option.  <p>

For example running the commands
<blockquote>
     swn -h www.abc.com -L abc.log /abc/root<br>
     swn -h www.def.com -L def.log /def/root
</blockquote>

will start two instances of the server, both on the same port (80) but
responding to different IP addresses.  The server will ascertain the
appropriate IP address by using the gethostbyname() system call
for the name supplied on the command line.  <i>Note: To use this
method make sure the #define INTERFACE_ROOT line in config.h is
commented out.</i>
<p>

This method has the disadvantage of using somewhat more resources
than the alternate method (described below) because at least one instance of
the server for each host name is running at all times and thus using
memory.  On the other hand with this method it is possible to specify
a different log file for each host, while the method below uses only
one log file and a utility to separate it into the contributions of
each host.
<p>

<h3>A Single Server with Multiple Virtual Hosts</h3>

The second method to implement a multi-homed server involves only a
single initial instance of the server which responds to all requests
and changes the document root as appropriate based on the IP address
or host name to which the request was sent.  To use this method you
need to edit the config.h file and uncomment the line

<blockquote>
     #define USE_VIRTUAL_HOSTS
</blockquote>
<p>

Then you have two choices.  You can either create a file
containing a list of the virtual hosts or you can build this
list into the compiled version of the sever by editing one of
the source files and recompiling.  If you have only a few 
virtual hosts and you don't anticipate adding new ones, I
recommend compiling in the list.  This is easy to do and much
more efficient if you use wn with inetd.  If you use swn there
is little difference in efficiency.
<p>

<h4>Compiling in the List of Virtual Hosts</h4>

To compile in the list of virtual hosts you need to edit the file
wn/vhost.h.  This file is quite short and contains something like

<pre>
     #ifdef INTERFACE_ROOT
     char *vhostlist[][3] =
     {
             { "xxx.xxx.xxx.1", "/path2/root1", "www.abc.com" },
             { "xxx.xxx.xxx.2", "/path2/root2", "www.def.com" },
             { "xxx.xxx.xxx.3", "/path2/root3", "www.ghi.com" },
             { NULL, NULL, NULL}
     };
     #endif
</pre> <p>

The line containing { "xxx.xxx.xxx.1", "/path2/root1", "www.abc.com},
should be replaced by a line containing one of the IP addresses of your
host instead of "xxx.xxx.xxx.1", the correct system path to the
corresponding data root instead of "/path2/root1" and the hostname
that corresponds to this IP address.  This hostname is used by the
server in only two ways: when a <a href="appendixB.html#redirect">
redirect header</a> is sent and to pass the correct server name to CGI
scripts in the environment variable
<p>

The other lines of this file should be changed in a similar fashion.
You may have more than three such lines if you wish and you should
remove any of the "xxx.xxx.xxx" lines you don't need.  Don't change
anything else.  In particular make sure that the { NULL, NULL, NULL}
line is unchanged and that you change only the parts in quotation
marks.  If the IP address by which the server is accessed does not
match any of the addresses listed in this file then the server will
use the default data root (as specified when you ran the "configure"
script or edited the value of ROOT_DIR in config.h).  <p>

The server will not produce separate log files for each IP address.
However, if the server is configured to produce verbose logs then each
entry is tagged at the end with the IP address which received the
request.  The <a href="utility.html#v2c"> utility v2c</a> can then be
used to produce separate log files for each IP address.  <p>

<h4>Using a Virtual Hosts List File</h4>

Instead of compiling in the list of virtual hosts you can keep this
list in a file which will be read each time the server starts.
To use this file you must uncomment the line

<blockquote>
	#define   VIRTUAL_HOSTS_FILE	"/usr/local/wn/virtual_hosts"
</blockquote>

in the file config.h and change the quoted path to the full path of a
file containing virtual host information in a format described below.
Then you must recompile the server.  Once this has been done you may
change the file you use with the <a href="appendixA.html#V_opt">
-V option</a> to the server.  But to turn this feature on, it is 
necessary that this #define be uncommented when the server is compiled.
Each time this file is changed, in order for the change to take effect,
 you will need to restart the server or send it the SIGHUP signal
with the "kill -HUP <process_id#>" command.
<p>

The format of this file is one line per virtual host.  Each such line
should have the form

<blockquote>
	hostname     IP_address     root_path
</blockquote>

with the three parts separated by white space.  For example an
entry might be

<blockquote>
	myhost.school.edu     111.222.333.444     /usr/local/wn
</blockquote>

In particular the hostname should be the fully qualified domain name.
Lines in this file which are empty or start with '#' are ignored.
<p>

WN now supports the "Host: " header implemented by some browsers
(e.g. Netscape2.x) and so-called "full URL requests".  For browsers that
support either of these features it is now possible to have multiple
virtual hosts with a single IP address!  The HTTP/1.1 protocol will
likely require browsers to support the Host: header.  
<p>

Using this feature requires nothing beyond setting up the server
exactly as described above for vitual hosts.  Of course, all your
virtual hosts will have the same IP number if your system only has
one.  Then if a browser provides the Host: header (which should 
contain the hostname and port it is trying to access) the WN server
will use the root data directory you specified for that host name.
Similarly if a full URL request like "GET http://host.abc.com/dir/foo.html"
is used the server will use the root data directory corresponding to
"host.abc.com".  If the browser provides neither of these the server
will use the first root data directory whose IP number matches (which
will be the first in your list if you have only one IP address).
<p>

<!-- #WN_end -->
<hr size="4">
<address>
John Franks &lt;john@math.nwu.edu&gt;
</address>
<!-- pnuts --> <a href="tilde.html">[Previous]</a> <a href="utility.html">[Next]</a> <a href="manual.html">[Up]</a> <a href="manual.html">[Top]</a> <a href="dosearch.html">[Search]</a> <a href="docindex.html">[Index]</a>
</body>
</html>
