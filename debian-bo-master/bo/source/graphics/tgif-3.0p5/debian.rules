#!/usr/bin/make -f
# debian.rules file for tgif
# Based on the sample debian.rules file written by Ian Jackson.
# Written by Christian Linhart in 1995 and 1996.
# I hereby place this file in the public domain.

package=tgif
version=3.0p5
debian=1
priority=extra
section=graphics
upgradepriority=low

arch=$(shell dpkg --print-architecture)
ctrlfilter=sed -e '2s/=/$(version)-$(debian)/; 3s/=/$(arch)/;' 
name=$(package)-$(version)-$(debian)
binary=$(name).$(arch).deb
source=$(name).tar.gz
diff=$(name).diff.gz
changes=$(name).changes

EXAMPLE_DIR=debian-tmp/usr/doc/examples/$(package)
EXAMPLE_SUBDIRS=$(EXAMPLE_DIR)/spice
EXAMPLES=example.tex *.obj *.sym *.pl spice/* tgif.Xdefaults 
DOC_DIR=debian-tmp/usr/doc/$(package)
DOCS=README debian.README debian.changelog Copyright

build:
	$(checkdir)
	xmkmf 
	$(MAKE) LOCAL_LDFLAGS=-s
	touch build

clean:
	$(checkdir)
	-rm -f build
	xmkmf
	-$(MAKE) -i clean
	-rm -rf debian-tmp *~ Makefile Makefile.bak

binary:		checkroot build
	-rm -rf debian-tmp
	mkdir debian-tmp debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	$(ctrlfilter) debian.control > debian-tmp/DEBIAN/control
	cp debian.postinst debian-tmp/DEBIAN/postinst
	cp debian.postrm debian-tmp/DEBIAN/postrm
	chmod +x debian-tmp/DEBIAN/{postinst,postrm}
	$(MAKE) CDEBUGFLAGS=-O2 INSTPGMFLAGS=-s DESTDIR=debian-tmp install install.man
	cp debian.copyright debian-tmp/usr/doc/copyright/$(package)
	install -d debian-tmp/etc/X11/$(package)
	install -d debian-tmp/usr/X11R6/lib/X11/app-defaults
	ln -s /etc/X11/$(package)/defaults debian-tmp/usr/X11R6/lib/X11/app-defaults/Tgif
	install -d $(EXAMPLE_DIR)
	install -d $(EXAMPLE_SUBDIRS)
	for example in $(EXAMPLES) ; do \
		gzip -9vc $$example >$(EXAMPLE_DIR)/$$example.gz ; done
	install -d $(DOC_DIR)
	for doc in $(DOCS) ; do \
		gzip -9vc $$doc >$(DOC_DIR)/$$doc.gz ; done
	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp
	mv debian-tmp.deb ../$(binary)

define checkdir
	test -f tgif.c
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)-$(version)-$(debian).tar $(package)-$(version) && \
	gzip -9vf $(package)-$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)-$(version).orig $(package)-$(version) \
	 >$(package)-$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)-$(version)-$(debian).diff

checkroot:
	$(checkdir)
	test root = "`whoami`"

#Below is for maintainer only (automatic announce & upload)
#Usage:
#	1. make all files (including the changes file):
#		as root: ./debian.rules allfiles
#	2. test the package. if not ok correct it and go back to 1.
#	3. announce & prepare for upload (put in the uploadqueue directory)
#		as chris: ./debian.rules announce


announceaddr=debian-devel@lists.debian.org

checkmaintainerhost:
	test baer.christian.linhart.nodomain = "`hostname -fqdn`"

announce: checkmaintainerhost upload
	( cat ../$(changes) ; echo ; echo -- ; cat ~chris/.signature ) \
		>../$(name).announce
	vi ../$(name).announce
	su chris -c 'mail $(announceaddr) \
		-s "uploading $(name)" <../$(name).announce'

upload: checkmaintainerhost
	su chris -c 'cp ../$(binary) ../$(diff) ../$(source) ../$(changes) \
		~chris/Debian/uploadqueue'

allfiles: binary source diff
	su chris -c "./debian.rules changes"
	
changes: ../$(binary) ../$(source) ../$(diff)
	#extract change info from changelog
	tmp=/tmp/$$$$ ; \
	perl -ne '\
		if ($$copy) {s/^\t//;print}; \
		$$copy=1 if ( /^\s+$(package)\s*\($(version)-$(debian)\)/ )' \
	< debian.changelog >$$tmp ; \
	cd .. ; dchanges -n ce=$$tmp pri=$(upgradepriority) \
		pgp="Christian Linhart <chris@cosy.sbg.ac.at>" \
		s=$(section) p=$(priority) $(binary) $(source) $(diff) ; \
	rm $$tmp

.PHONY: binary source diff clean checkroot changes
