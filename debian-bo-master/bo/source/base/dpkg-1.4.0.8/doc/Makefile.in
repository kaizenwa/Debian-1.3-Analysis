# Copyright (C) 1994 Ian Murdock <imurdock@debian.org>
# Copyright (C) 1994,1995 Ian Jackson <ijackson@nyx.cs.du.edu>
#
#   This is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as
#   published by the Free Software Foundation; either version 2,
#   or (at your option) any later version.
#
#   This is distributed in the hope that it will be useful, but
#   WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public
#   License along with dpkg; if not, write to the Free Software
#   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
infodir = $(prefix)/info
mandir = $(prefix)/man
man5dir = $(mandir)/man5
man5 = 5
docdir = $(prefix)/doc
dpkgdocdir = $(docdir)/dpkg

DIST = Makefile.in $(SRC) $(MAN)

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

MAKEINFO = makeinfo
TEXI2DVI = texi2dvi

SGMLDOCSTAMPS= programmer.html-stamp policy.html-stamp

# Files folded into manuals
OBSOLETEDOCS= descriptions.txt upgrades+errors.txt \
 maintainer-script-args.txt virtual-dependencies.txt \
 auto-deconfiguration.txt dependency-ordering.txt \
 disappear-replace.txt diversions.text \
 essential-flag.txt version-ordering.txt

all:		$(DPKGDOCS) $(SGMLDOCSTAMPS)

manuals-version:	changelog Makefile
		v=`dpkg-parsechangelog -lchangelog | sed -n 's/^Version: //p'` && \
		echo "<!entity manuals-version \"$$v\">" >$@.new
		d=`pwd | sed -e 's,/doc$$,,; s,^.*dpkg-\([0-9.]*\),\1,'` && \
		echo "<!entity dpkg-version \"$$d\">" >>$@.new
		mv -f $@.new $@

%.html-stamp:	%.sgml manuals-version
		rm -rf $*.html
		debiandoc2html $<
		touch $@

guidelines.info: guidelines.texi
		$(MAKEINFO) $(srcdir)/guidelines.texi

database-structure.ps:	database-structure.fig
		fig2dev -L ps -c -l _ -P <database-structure.fig >ps
		mv -f ps database-structure.ps

database-structure.monops: database-structure.ps
		perl -pe 's:^/(col[0-7]) \{[01 ]*1[01 ]* setrgbcolor\}\
 bind def$$:/$$1 {} bind def:' database-structure.ps >ps
		mv -f ps database-structure.monops

clean:
		rm -f $(SGMLDOCSTAMPS)
		rm -f database-structure.ps database-structure.monops ps
		rm -f *.{aux,cp,dvi,fn,ky,log,pg,toc,tp,vr,bak}
		rm -f guidelines.info*
		rm -rf {programmer,policy}.{html*,sasp*,text*,ps*,lout*}

distclean:
		rm -f Makefile *.orig *~ *.~* ./#*#

install:	all
		$(INSTALL_DATA) deb.5 $(man5dir)/deb.$(man5)
		$(INSTALL_DATA) deb-old.5 $(man5dir)/deb-old.$(man5)
		$(INSTALL_DATA) deb-control.5 $(man5dir)/deb-control.$(man5)
		set -e; for f in $(SGMLDOCSTAMPS) ; do \
			g=`echo $$f | sed -e 's/-stamp$$//'` ; \
			cp -r $$g $(dpkgdocdir)/$$g ; \
		done
		$(INSTALL_DATA) developer-keys.pgp $(dpkgdocdir)/.
		$(INSTALL_DATA) ../debian/changelog $(dpkgdocdir)/changelog.dpkg
		$(INSTALL_DATA) changelog $(dpkgdocdir)/changelog.manuals
