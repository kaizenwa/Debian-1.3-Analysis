#!/usr/bin/make -f

package=lshell
version=2.01
debian=3
arch=$(shell dpkg --print-architecture)

gccversion=$(shell gcc -v 2>&1 | tail -1 | cut -d' ' -f3)
ifeq ($(gccversion),2.7.2.l.3)
CC = gcc -V2.7.2
else
CC = gcc
endif


EXAMPLE_DIR=debian-tmp/usr/doc/examples/$(package)
EXAMPLES=
DOC_DIR=debian-tmp/usr/doc/$(package)
DOCS=debian.README debian.changelog README debian.newshell

build:	lshell
	touch build

lshell:	lshell.c
	$(checkdir)
	$(CC) -O2 -s lshell.c -o lshell

clean:
	$(checkdir)
	/bin/rm -f build lshell *~

binary:		build
	test -f build || make -f debian.rules build
	@-[ "`whoami`" != root ] && \
		echo "Enter the root password to build the .deb file"
	@su -c "umask 22; exec make -f debian.rules binary-root"

binary-root:
	install -d debian-tmp/DEBIAN
	install -d debian-tmp/usr/doc/copyright
	sed -e '2s/=V/$(version)-$(debian)/' -e '9s/=A/$(arch)/' \
		debian.control > debian-tmp/DEBIAN/control
	install -m 755 debian.postinst debian-tmp/DEBIAN/postinst
	install -m 755 debian.prerm   debian-tmp/DEBIAN/prerm
	install -m 755 debian.postrm   debian-tmp/DEBIAN/postrm
	install -m 644 debian.conffiles debian-tmp/DEBIAN/conffiles
	install -d debian-tmp/bin/lshells
	install -d debian-tmp/usr/bin/lshells
	install -d debian-tmp/usr/man/man8
	install -m 755 -o root -g root lshell debian-tmp/usr/bin
	install -m 644 -o root -g root lshell.8 debian-tmp/usr/man/man8
	gzip -9 debian-tmp/usr/man/man8/lshell.8
	cp debian.copyright debian-tmp/usr/doc/copyright/$(package)
	chmod 644 debian-tmp/usr/doc/copyright/$(package)
	install -d debian-tmp/etc
	install -m 755  limits 	debian-tmp/etc/lshell.conf
	install -d $(DOC_DIR)
	for doc in $(DOCS) ; do \
		gzip -9vc $$doc >$(DOC_DIR)/$$doc.gz ; done
	chown -R root.root debian-tmp
	chmod -R g-ws debian-tmp
	dpkg --build debian-tmp
	dpkg-name -o -s .. debian-tmp.deb
	/bin/rm -rf debian-tmp

changes: binary diff source
	( echo ; \
	  perl -ne '\
		$$l2=$$l1; $$l1=$$l0; $$l0=$$_; \
		if ( /^\s+$(package)\s*\($(version)-$(debian)\)/ ) \
			{ print "$$l2$$l1"; $$copy=1 } \
		print if $$copy;' \
	  < debian.changelog ; \
	) > ../$(package)_$(version)-$(debian).new
	( cd ..; \
	  dchanges ce=$(package)_$(version)-$(debian).new \
		   $(package)_$(version)-$(debian)_$(arch).deb\
	           $(package)_$(version)-$(debian).tar.gz \
	           $(package)_$(version)-$(debian).diff.gz \
	)

#Sun Apr 16 21:14:53 MET DST 1995 Christian Linhart <chris@cosy.sbg.ac.at>
#md5sum target:
#creates a file which contains names, sizes and md5sums of the files
#which are to uploaded (*.deb, *.tar.gz, *.diff.gz).
#The file gets the suffix .md5sum and is put into the parent directory.
#Because of it's dependencies this target creates the debianizing diff 
#and the binary and source packages.
md5sum: binary source diff changes
	( cd .. ; \
	  echo "MD5 checksum                            Size" ; \
	  for i in $(package)_$(version)-$(debian){_$(arch).deb,.tar.gz,.diff.gz,changes} ; do \
	        printf "%s %11d %s\n" `md5sum <$$i` `wc -c <$$i` $$i; done \
	) >../$(package)_$(version)-$(debian).md5sum


#Sun Apr 16 21:14:53 MET DST 1995 Christian Linhart <chris@cosy.sbg.ac.at>
#announce target:
#create a file containing the required part of the announce message, namely
# * the part of the changelog for the current release,
# * md5sums and sizes of files.
#The file gets the suffix .announce and is put into the parent directory.
#
#The below script is based on the following assumptions: 
# * The changelog is in the file debian.changelog,
# * The changelog entries for a release are below a line which 
#	- Starts with one or more whitespace characters,
#	- after that contains the package name followed by the version 
#	  in parentheses.
#   (anyway, for details read the regexp in the first if-statement)
# * Two lines before the above described line there is a line
#   containing the date and the package maintainer's name.
#
#Because of it's dependencies this target creates the md5sum-file, the
#debianizing diff and the binary and source packages. Thus if all works
#well, 
#	./debian.rules announce 
#creates all files necessary for uploading. 
announce: md5sum
	( dpkg --info ../$(package)_$(version)-$(debian)_$(arch).deb ; \
	  echo ; \
	  perl -ne '\
		$$l2=$$l1; $$l1=$$l0; $$l0=$$_; \
		if ( /^\s+$(package)\s*\($(version)-$(debian)\)/ ) \
			{ print "$$l2$$l1"; $$copy=1 } \
		print if $$copy;' \
	  < debian.changelog ; \
	  echo ; \
	  cat ../$(package)_$(version)-$(debian).md5sum \
	) >../$(package)_$(version)-$(debian).announce
define checkdir
	test -f lshell.1 
endef

# Below here is fairly generic really

source:		clean
	chmod +x debian.rules
	cd .. && \
	tar cf $(package)_$(version)-$(debian).tar $(package)_$(version) && \
	gzip -9vf $(package)_$(version)-$(debian).tar
 
diff:		clean
	cd .. && \
	(diff -ruN $(package)_$(version).orig $(package)_$(version) \
	 >$(package)_$(version)-$(debian).diff; [ $$? = 1 ]) && \
	gzip -9vf $(package)_$(version)-$(debian).diff


