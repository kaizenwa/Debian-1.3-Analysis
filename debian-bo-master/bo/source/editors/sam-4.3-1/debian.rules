#!/usr/bin/make -f
# Copyright 1994,1995 by Ian Jackson, and Raul Miller.
# We hereby give you perpetual unlimited permission to copy, modify and
# relicense this file, provided that you do not remove our names from
# the file itself.  (We assert our moral right of paternity under the
# Copyright, Designs and Patents Act 1988.)


package=sam
version=4.3-1

DIR = $(package)-$(version)
DEB = $(DIR).deb
SRC = $(DIR).tar.gz
DIF = $(DIR).diff.gz

t=debian-tmp
D=DEBIAN

# The next section may have to be extensively modified

checkdir=libXg/rune.c

build: 			$(checkdir)
	make all
	date >build

clean:			$(checkdir)
	make clean
	find . -name core -o -name '*~' -o -name '#*' -print | xargs rm -f
	rm -rf $(package)-* ../t$(DIR) $t build ._*

SAM=sam/sam
root:
	-rm -rf $t
	install -d $t
	#	DEBIAN
	install -d $t/$D
	sed -e 's/^Version: =/Version: $(version)/' <$D/control > $t/$D/control
	cp -Raul $D/p* $t/$D/
	chmod +x DEBIAN/p*
	#	/usr/lib/sam
	install -d $t/usr/lib/sam
	cp -Raul sam/samsave samterm/samterm $t/usr/lib/sam/
	chmod a+x $t/usr/lib/sam/*
	strip $t/usr/lib/sam/samterm
	#	/usr/bin
	install -d $t/usr/bin
	cp -Raul sam/sam $t/usr/bin/sam
	cp -Raul sam/B.sh $t/usr/bin/B
	chmod a+x $t/usr/bin/*
	strip $t/usr/bin/sam
	#	/usr/man
	install -d $t/usr/man/man1
	cp doc/sam.1 $t/usr/man/man1/sam.1
	install -d $t/usr/man/man6
	cp doc/regexp.6 $t/usr/man/man6/regexp.6
	$(SAM) -d <man.sam $t/usr/man/man?/*
	#	/usr/doc
	install -d $t/usr/doc/sam
	cp README doc/* $t/usr/doc/sam
	rm $t/usr/doc/sam/{sam.1,regexp.6,Sam.ad}
	$(SAM) -d <man.sam $t/usr/doc/sam/*.?
	install -d $t/usr/doc/examples/sam
	cp sam/B.* $t/usr/doc/examples/sam/
	cp doc/Sam.ad $t/usr/doc/examples/sam/Sam.ad
	gzip -9vr $t/usr/doc
	install -d $t/usr/doc/copyright
	cp -Raul debian.README $t/usr/doc/copyright/sam
	# 
	chmod -R a+r $t
	chmod -R go-ws $t
	dpkg --build $t
	mv -f $t.deb $(DEB)

# Below here is fairly generic

all: binary source diff

######################################################################
binary:			../$(DEB)
../$(DEB):		 $(DEB)
	ln -f $(DEB) ..
$(DEB):			build $(wildcard $D/*)
	# we need root to set ownership on files in archive
	# there ought to be a better way...
	su -c 'make -f debian.rules root'

######################################################################
source: 		../$(SRC)
../$(SRC):		 $(SRC)
	ln -f $(SRC) $@
$(SRC): 		._$(DIR)
	tar cf $(DIR).tar $(DIR)
	gzip -9vf $(DIR).tar

######################################################################
diff:			../$(DIF)
../$(DIF): $(DIF)
	ln -f $(DIF) $@
$(DIF):			._$(DIR) $(origdir)
	(diff -ruN debian-orig $(DIR) >$(DIR).diff; [ $$? = 1 ])
	gzip -9vf $(DIR).diff

######################################################################
origdir=debian-orig/$(checkdir)

._$(DIR):		$(wildcard debian.*) $(wildcard $D/*) $(checkdir)
	rm -rf $(package)-*/ ../t$(DIR)	 # get rid of any existing source dir
	chmod +x debian.rules
	cp -Raul . ../t$(DIR)		 # make prototype source dir
	mv ../t$(DIR) ./$(DIR)		 # give it proper path name
	cd $(DIR); ./debian.rules clean	 # remove any binaries, if present
	cd $(DIR); rm -rf debian-orig Extra	 # final clean up
	touch $@			 # mark target as done

.PHONY:			all binary clean diff root source
